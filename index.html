<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‰ãƒ­ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ–</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .start-screen {
            text-align: center;
            padding: 40px;
        }

        .game-title {
            font-size: 3em;
            color: #333;
            margin-bottom: 20px;
        }

        .rules {
            text-align: left;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .rules ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .rules li {
            margin: 8px 0;
        }

        .btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn.ai-mode {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .game-screen {
            display: none;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .game-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .players {
            display: flex;
            gap: 30px;
        }

        .player {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
        }

        .player.active {
            font-weight: bold;
        }

        .player.ai {
            font-style: italic;
        }

        .player-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .red { background: #ef4444; }
        .blue { background: #3b82f6; }

        .timer {
            font-size: 24px;
            font-weight: bold;
        }

        .timer.warning {
            color: #ef4444;
            animation: blink 1s infinite;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }

        .grid-container {
            text-align: center;
            padding: 20px;
            overflow-x: auto;
        }

        .grid {
            display: inline-grid;
            grid-template-columns: repeat(15, 32px);
            gap: 2px;
            background: #ddd;
            padding: 10px;
            border-radius: 8px;
            min-width: max-content;
        }

        .cell {
            width: 32px;
            height: 32px;
            background: white;
            border: 3px solid transparent;
            box-sizing: border-box;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .cell:hover {
            background: #f0f0f0;
            border-color: #ddd;
        }

        .cell.ground {
            background: #fef3c7;
            border-bottom-color: #d97706;
        }

        .cell.red {
            background: #ef4444;
            color: white;
            border-color: #dc2626;
        }

        .cell.blue {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
        }

        .cell.winning {
            border-color: #fbbf24;
            animation: winningBlink 1s infinite;
            box-shadow: 0 0 10px #fbbf24;
        }

        .cell.dropping {
            animation: drop 0.5s ease-out;
        }

        .ground-label {
            margin-top: 15px;
            color: #d97706;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .winner-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 20px;
        }

        .alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ef4444;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 1001;
            animation: alertShow 0.3s ease-out;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }

        @keyframes winningBlink {
            0%, 100% { 
                border-color: #fbbf24;
                box-shadow: 0 0 10px #fbbf24;
            }
            50% { 
                border-color: #f59e0b;
                box-shadow: 0 0 20px #f59e0b;
            }
        }

        @keyframes drop {
            0% { transform: translateY(-20px); opacity: 0.7; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes turnFlash {
            0% { transform: scale(1); opacity: 1; }
            30% { transform: scale(1.3); opacity: 0.8; }
            60% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        .player.flash {
            animation: turnFlash 0.8s ease-out;
            color: #fbbf24;
        }

        @keyframes alertShow {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        @media (max-width: 600px) {
            .grid {
                grid-template-columns: repeat(15, 20px);
            }
            .cell {
                width: 20px;
                height: 20px;
                font-size: 12px;
            }
            .game-status {
                flex-direction: column;
                gap: 15px;
            }
            .players {
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
        <div id="startScreen" class="card start-screen">
            <h1 class="game-title">ãƒ‰ãƒ­ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ–</h1>
            <p>2äººå¯¾æˆ¦ãƒ–ãƒ­ãƒƒã‚¯é…ç½®ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ </p>
            
            <div class="rules">
                <h3>ğŸ“‹ ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«</h3>
                <ul>
                    <li>å…ˆè¡Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è‰²ã®ãƒ–ãƒ­ãƒƒã‚¯ãŒä¸­å¤®ã«1å€‹é…ç½®ã•ã‚Œã¾ã™</li>
                    <li>å…ˆè¡Œã¯åˆæ‰‹ã§1å€‹ã®ã¿é…ç½®å¯èƒ½</li>
                    <li>2ã‚¿ãƒ¼ãƒ³ç›®ä»¥é™ã¯å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ1ã‚¿ãƒ¼ãƒ³ã«2å€‹é…ç½®</li>
                    <li>ç¸¦ãƒ»æ¨ªãƒ»æ–œã‚ã®ã„ãšã‚Œã‹ã§5å€‹é€£ç¶šã«ä¸¦ã¹ã‚‹ã¨å‹åˆ©</li>
                    <li>1éšï¼ˆåœ°é¢ï¼‰ã§ã¯éš£æ¥ã™ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ãŒå¿…è¦</li>
                    <li>2éšä»¥ä¸Šã§ã¯éš£æ¥åˆ¶é™ãªã—</li>
                    <li>ãƒ–ãƒ­ãƒƒã‚¯ã¯é‡åŠ›ã§è‡ªå‹•çš„ã«è½ä¸‹</li>
                    <li>åˆ¶é™æ™‚é–“å†…ã«é…ç½®ã—ãªã„ã¨è² ã‘</li>
                </ul>
            </div>

            <div style="margin: 20px 0;">
                <label style="font-weight: bold; color: #333;">ğŸ¤– AIã®å¼·ã•ã‚’é¸ã¶ï¼š</label><br>
                <select id="aiLevelSelect" style="padding: 8px 16px; font-size: 16px; border-radius: 6px;">
                    <option value="1">Lv1ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰</option>
                    <option value="2">Lv2ï¼ˆæ”»æ’ƒå‹ï¼‰</option>
                    <option value="3">Lv3ï¼ˆæ”»é˜²å‹ï¼‰</option>
                    <option value="4">Lv4ï¼ˆé«˜åº¦AIï¼‰</option>
                    <option value="5">Lv5ï¼ˆãƒŸãƒ‹ãƒãƒƒã‚¯ã‚¹ - ç ´å£Šçš„å¼·ã•ï¼‰</option>
                    <option value="6">Lv6ï¼ˆå­¦ç¿’å‹AI - ã‚ãªãŸå°‚ç”¨ï¼‰</option>
                </select>
            </div>
            
            <button class="btn" onclick="startGame(false)">ğŸ‘¥ 2äººå¯¾æˆ¦</button>
            <button class="btn ai-mode" onclick="startGame(true)">ğŸ¤– AIã¨å¯¾æˆ¦</button>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="gameScreen" class="game-screen">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="card">
                <div class="game-header">
                    <h2>ãƒ‰ãƒ­ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ–</h2>
                    <div>
                        <button class="btn" onclick="showStart()">æ–°ã—ã„ã‚²ãƒ¼ãƒ </button>
                        <button class="btn" onclick="endGameNow()" style="background: #dc2626; margin-left: 10px;">ã‚²ãƒ¼ãƒ çµ‚äº†</button>
                    </div>
                </div>
            </div>

            <!-- ã‚²ãƒ¼ãƒ çŠ¶æ³ -->
            <div class="card">
                <div class="game-status">
                    <div class="players">
                        <div class="player" id="player1">
                            <div class="player-color red"></div>
                            <span>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</span>
                        </div>
                        <div class="player" id="player2">
                            <div class="player-color blue"></div>
                            <span>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2</span>
                        </div>
                    </div>
                    <div class="timer" id="timer">5:00</div>
                </div>
                <div class="game-info">
                    <div>ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³: <span id="currentPlayer">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</span></div>
                    <div>æ®‹ã‚Šãƒ–ãƒ­ãƒƒã‚¯: <span id="remainingBlocks">1</span>/<span id="maxBlocks">1</span></div>
                    <div id="aiStats" style="color: #8b5cf6; font-weight: bold;"></div>
                </div>
            </div>

            <!-- ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ -->
            <div class="card grid-container">
                <div class="grid" id="gameGrid"></div>
                <div class="ground-label">â¬†ï¸ åœ°é¢ãƒ¬ãƒ™ãƒ«ï¼ˆéš£æ¥ãƒ–ãƒ­ãƒƒã‚¯å¿…è¦ï¼‰</div>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ çµ‚äº†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="gameModal" class="modal">
            <div class="modal-content">
                <h2 id="modalTitle">ã‚²ãƒ¼ãƒ çµ‚äº†</h2>
                <div class="winner-icon" id="winnerIcon"></div>
                <p id="modalMessage">çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
                <button class="btn" onclick="startGame(false)">2äººå¯¾æˆ¦</button>
                <button class="btn ai-mode" onclick="startGame(true)">AIã¨å¯¾æˆ¦</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/4.2.0/tf.min.js"></script>
    <script>
        // ã‚²ãƒ¼ãƒ è¨­å®š
        var GRID_WIDTH = 15;
        var GRID_HEIGHT = 12;
        var WIN_COUNT = 5;
        var BLOCKS_PER_TURN = 2;
        var aiLevel = 1;

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        var game = {
            grid: [],
            currentPlayer: 1,
            firstPlayer: 1,
            aiPlayer: null,
            remainingBlocks: 1,
            timeLeft: 30,
            gameActive: false,
            timer: null,
            animating: false,
            winningCells: [],
            showingWin: false,
            turnCount: 0,
            isAI: false,
            aiThinking: false
        };

        // ã‚°ãƒªãƒƒãƒ‰åˆæœŸåŒ–
        function initGrid() {
            game.grid = [];
            for (var row = 0; row < GRID_HEIGHT; row++) {
                game.grid[row] = [];
                for (var col = 0; col < GRID_WIDTH; col++) {
                    game.grid[row][col] = 0;
                }
            }
        }

        // å‹åˆ©ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showWinningCells() {
            // å®Ÿéš›ã®å‹åˆ©æ™‚ã®ã¿å‘¼ã°ã‚Œã‚‹ãŸã‚ã€ç‰¹åˆ¥ãªå‡¦ç†ã¯ä¸è¦
            // updateGrid()ã§å‹åˆ©ã‚»ãƒ«ãŒè‡ªå‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹
            console.log("å‹åˆ©ãƒ©ã‚¤ãƒ³è¡¨ç¤º:", game.winningCells);
        }

        // å‹åˆ©ãƒ©ã‚¤ãƒ³ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
        function clearWinningCells() {
            game.winningCells = [];
            console.log("å‹åˆ©ãƒ©ã‚¤ãƒ³ã‚¯ãƒªã‚¢");
        }

        // â˜…ä¿®æ­£ç‰ˆâ˜… ã‚²ãƒ¼ãƒ é–‹å§‹é–¢æ•°
        function startGame(isVsAI) {
            if (typeof isVsAI === 'undefined') {
                isVsAI = false;
            }
            
            // AIãƒ¬ãƒ™ãƒ«å–å¾—
            var levelSelect = document.getElementById('aiLevelSelect');
            aiLevel = levelSelect ? parseInt(levelSelect.value) : 1;

            // åˆæœŸåŒ–
            initGrid();
            game.firstPlayer = Math.random() > 0.5 ? 1 : 2;
            game.currentPlayer = game.firstPlayer;
            
            if (isVsAI) {
                game.aiPlayer = Math.random() > 0.5 ? 1 : 2;
            } else {
                game.aiPlayer = null;
            }
            
            game.remainingBlocks = 1;
            game.timeLeft = 30;
            game.gameActive = true;
            game.animating = false;
            clearWinningCells(); // â˜…ä¿®æ­£â˜… å‹åˆ©ãƒ©ã‚¤ãƒ³ã‚’ç¢ºå®Ÿã«ã‚¯ãƒªã‚¢
            game.showingWin = false;
            game.turnCount = 0;
            game.isAI = isVsAI;
            game.aiThinking = false;

            // ä¸­å¤®ãƒ–ãƒ­ãƒƒã‚¯é…ç½®
            var centerCol = Math.floor(GRID_WIDTH / 2);
            var groundRow = GRID_HEIGHT - 1;
            game.grid[groundRow][centerCol] = game.firstPlayer;

            console.log(`ã‚²ãƒ¼ãƒ é–‹å§‹ - å…ˆæ”»: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${game.firstPlayer}, AI: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${game.aiPlayer}`);

            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            document.getElementById('gameModal').style.display = 'none';

            // ã‚°ãƒªãƒƒãƒ‰ä½œæˆãƒ»è¡¨ç¤ºæ›´æ–°
            createGrid();
            updateDisplay();
            startTimer();
            
            // AIãŒå…ˆæ”»ã®å ´åˆ
            if (game.isAI && game.currentPlayer === game.aiPlayer) {
                console.log("AIãŒå…ˆæ”»ã§å‹•ä½œé–‹å§‹");
                setTimeout(cpuPlay, 1500);
            }
        }

        // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        function startTimer() {
            clearInterval(game.timer);
            
            game.timer = setInterval(function() {
                game.timeLeft--;
                updateDisplay();
                
                if (game.timeLeft <= 0) {
                    clearInterval(game.timer);
                    var winner = game.currentPlayer === 1 ? 2 : 1;
                    showAlert(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${game.currentPlayer}ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼`);
                    setTimeout(function() {
                        endGame(winner);
                    }, 2000);
                }
            }, 1000);
        }

        // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢è¡¨ç¤º
        function showStart() {
            clearInterval(game.timer);
            clearWinningCells(); // â˜…ä¿®æ­£â˜… å‹åˆ©ãƒ©ã‚¤ãƒ³ã‚’ã‚¯ãƒªã‚¢
            game.aiThinking = false;
            
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('gameModal').style.display = 'none';
        }

        // ã‚°ãƒªãƒƒãƒ‰ä½œæˆ
        function createGrid() {
            var gridElement = document.getElementById('gameGrid');
            gridElement.innerHTML = '';
            
            updateGridTemplate();

            for (var row = 0; row < GRID_HEIGHT; row++) {
                for (var col = 0; col < GRID_WIDTH; col++) {
                    var cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.onclick = function() {
                        var clickedRow = parseInt(this.dataset.row);
                        var clickedCol = parseInt(this.dataset.col);
                        placePiece(clickedRow, clickedCol);
                    };

                    if (row === GRID_HEIGHT - 1) {
                        cell.classList.add('ground');
                    }

                    gridElement.appendChild(cell);
                }
            }
        }

        // ç”»é¢è¡¨ç¤ºæ›´æ–°
        function updateDisplay() {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤º
            document.getElementById('player1').classList.toggle('active', game.currentPlayer === 1);
            document.getElementById('player2').classList.toggle('active', game.currentPlayer === 2);
            
            // AIè¡¨ç¤º
            if (game.isAI) {
                var aiElement = game.aiPlayer === 1 ? 
                    document.getElementById('player1') : 
                    document.getElementById('player2');
                aiElement.classList.add('ai');
                aiElement.querySelector('span').textContent = `AI (Lv${aiLevel})`;
                
                var humanElement = game.aiPlayer === 1 ? 
                    document.getElementById('player2') : 
                    document.getElementById('player1');
                humanElement.classList.remove('ai');
                humanElement.querySelector('span').textContent = game.aiPlayer === 1 ? 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2' : 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
            } else {
                document.getElementById('player1').classList.remove('ai');
                document.getElementById('player2').classList.remove('ai');
                document.getElementById('player1').querySelector('span').textContent = 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
                document.getElementById('player2').querySelector('span').textContent = 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';
            }
            
            // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤º
            var currentPlayerName;
            if (game.currentPlayer === 1) {
                currentPlayerName = (game.isAI && game.aiPlayer === 1) ? `AI (Lv${aiLevel})` : 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
            } else {
                currentPlayerName = (game.isAI && game.aiPlayer === 2) ? `AI (Lv${aiLevel})` : 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';
            }
            document.getElementById('currentPlayer').textContent = currentPlayerName;
            
            // ãƒ–ãƒ­ãƒƒã‚¯æ•°è¡¨ç¤º
            document.getElementById('remainingBlocks').textContent = game.remainingBlocks;
            var maxBlocks = game.turnCount === 0 ? 1 : BLOCKS_PER_TURN;
            document.getElementById('maxBlocks').textContent = maxBlocks;
            
            // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º
            var minutes = Math.floor(game.timeLeft / 60);
            var seconds = game.timeLeft % 60;
            var timerElement = document.getElementById('timer');
            timerElement.textContent = minutes + ':' + seconds.toString().padStart(2, '0');
            timerElement.classList.toggle('warning', game.timeLeft <= 30);

            updateGrid();
        }

        // ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºæ›´æ–°
        function updateGrid() {
            var cells = document.querySelectorAll('.cell');
            var index = 0;
            
            for (var row = 0; row < GRID_HEIGHT; row++) {
                for (var col = 0; col < GRID_WIDTH; col++) {
                    var cell = cells[index];
                    if (!cell) continue;
                    
                    var value = game.grid[row][col];
                    
                    cell.className = 'cell';
                    if (row === GRID_HEIGHT - 1) {
                        cell.classList.add('ground');
                    }
                    
                    if (value === 1) {
                        cell.classList.add('red');
                        cell.textContent = 'â—';
                    } else if (value === 2) {
                        cell.classList.add('blue');
                        cell.textContent = 'â—';
                    } else {
                        cell.textContent = '';
                    }
                    
                    index++;
                }
            }
            
            // â˜…ä¿®æ­£â˜… å‹åˆ©ç¢ºå®šæ™‚ã®ã¿é»„è‰²ã„æ ã‚’è¡¨ç¤º
            if (game.showingWin && game.winningCells.length > 0) {
                for (var w = 0; w < game.winningCells.length; w++) {
                    var r = game.winningCells[w][0];
                    var c = game.winningCells[w][1];
                    var idx = r * GRID_WIDTH + c;
                    if (cells[idx]) {
                        cells[idx].classList.add('winning');
                    }
                }
            }
        }

        // åœ°é¢é…ç½®ãƒã‚§ãƒƒã‚¯
        function isValidGroundPlacement(col) {
            var groundRow = GRID_HEIGHT - 1;
            var leftCol = col - 1;
            var rightCol = col + 1;
            
            // å·¦å³éš£æ¥ãƒã‚§ãƒƒã‚¯
            if (leftCol >= 0 && game.grid[groundRow][leftCol] !== 0) {
                return true;
            }
            if (rightCol < GRID_WIDTH && game.grid[groundRow][rightCol] !== 0) {
                return true;
            }
            
            return false;
        }

        // é…ç½®å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆé‡åŠ›ãƒ»éš£æ¥ãƒ«ãƒ¼ãƒ«å«ã‚€ï¼‰
        function isValidPlacement(row, col) {
            if (row < 0 || row >= GRID_HEIGHT || col < 0 || col >= GRID_WIDTH) {
                return false;
            }
            if (game.grid[row][col] !== 0) {
                return false;
            }
            if (row < GRID_HEIGHT - 1 && game.grid[row + 1][col] === 0) {
                return false;
            }
            if (row === GRID_HEIGHT - 1 && !isValidGroundPlacement(col)) {
                return false;
            }
            return true;
        }

        // æœ‰åŠ¹ãªæ‰‹ã‚’ã™ã¹ã¦å–å¾—
        function getAllValidMoves() {
            var validMoves = [];
            
            for (var row = 0; row < GRID_HEIGHT; row++) {
                for (var col = 0; col < GRID_WIDTH; col++) {
                    if (game.grid[row][col] !== 0) continue;
                    
                    var hasSupport = (row === GRID_HEIGHT - 1) || 
                                    (row + 1 < GRID_HEIGHT && game.grid[row + 1][col] !== 0);
                    
                    if (hasSupport) {
                        if (row === GRID_HEIGHT - 1) {
                            if (isValidGroundPlacement(col)) {
                                validMoves.push([row, col]);
                            }
                        } else {
                            validMoves.push([row, col]);
                        }
                    }
                }
            }
            
            return validMoves;
        }

        // ãƒ©ãƒ³ãƒ€ãƒ ãªæ‰‹ã‚’é¸æŠ
        function getRandomMove() {
            const validMoves = getAllValidMoves();
            if (validMoves.length === 0) return null;
            const randomIndex = Math.floor(Math.random() * validMoves.length);
            return validMoves[randomIndex];
        }

        // â˜…ä¿®æ­£ç‰ˆâ˜… å‹åˆ©å¯èƒ½ãªæ‰‹ã‚’æ¢ã™ï¼ˆAIæ¢ç´¢æ™‚ã«winningCellsã‚’æ±šæŸ“ã—ãªã„ï¼‰
        function findWinningMove(player) {
            console.log(`å‹åˆ©æ‰‹æ¤œç´¢é–‹å§‹ - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${player}`);
            
            // ç¾åœ¨ã®winningCellsã‚’ä¿å­˜
            var originalWinningCells = game.winningCells.slice();
            
            for (var row = 0; row < GRID_HEIGHT; row++) {
                for (var col = 0; col < GRID_WIDTH; col++) {
                    if (game.grid[row][col] !== 0) continue;
                    if (!isValidPlacement(row, col)) continue;
                    
                    game.grid[row][col] = player;
                    var canWin = checkWin(row, col);
                    game.grid[row][col] = 0;
                    
                    if (canWin) {
                        console.log(`å‹åˆ©æ‰‹ç™ºè¦‹: (${row}, ${col}) - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${player}ãŒå‹åˆ©`);
                        // â˜…ä¿®æ­£â˜… æ¢ç´¢ã§æ±šæŸ“ã•ã‚ŒãŸwinningCellsã‚’å¾©å…ƒ
                        game.winningCells = originalWinningCells;
                        return [row, col];
                    }
                }
            }
            
            // â˜…ä¿®æ­£â˜… æ¢ç´¢ã§æ±šæŸ“ã•ã‚ŒãŸwinningCellsã‚’å¾©å…ƒ
            game.winningCells = originalWinningCells;
            console.log("å‹åˆ©æ‰‹ãªã—");
            return null;
        }

        // â˜…ä¿®æ­£ç‰ˆâ˜… è©¦åˆæ®µéšåˆ¤å®šï¼ˆåºç›¤ãƒ»ä¸­ç›¤ãƒ»çµ‚ç›¤ï¼‰
        function getGamePhase() {
            var totalBlocks = 0;
            for (var row = 0; row < GRID_HEIGHT; row++) {
                for (var col = 0; col < GRID_WIDTH; col++) {
                    if (game.grid[row][col] !== 0) {
                        totalBlocks++;
                    }
                }
            }
            
            if (totalBlocks < 15) {
                return 'early'; // åºç›¤
            } else if (totalBlocks < 30) {
                return 'middle'; // ä¸­ç›¤
            } else {
                return 'late'; // çµ‚ç›¤ï¼ˆ30å€‹ä»¥ä¸Šã§ç¸¦2é€£æˆ¦ç•¥é–‹å§‹ï¼‰
            }
        }

        // â˜…æ–°è¦è¿½åŠ â˜… ç¸¦2é€£ä½œæˆæˆ¦ç•¥
        function findVerticalDoubleMove(player) {
            console.log(`ç¸¦2é€£ä½œæˆæˆ¦ç•¥æ¤œç´¢é–‹å§‹ - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${player}`);
            
            var validMoves = getAllValidMoves();
            var bestMove = null;
            var bestScore = 0;
            
            for (var i = 0; i < validMoves.length; i++) {
                var move = validMoves[i];
                var row = move[0];
                var col = move[1];
                
                // ã“ã®ä½ç½®ã«ç½®ã„ãŸå ´åˆã®ç¸¦2é€£åŠ¹æœã‚’è©•ä¾¡
                game.grid[row][col] = player;
                
                var verticalScore = evaluateVerticalDouble(row, col, player);
                
                game.grid[row][col] = 0;
                
                if (verticalScore > bestScore) {
                    bestScore = verticalScore;
                    bestMove = move;
                }
            }
            
            if (bestMove && bestScore > 50) {
                console.log(`ç¸¦2é€£ä½œæˆæ‰‹é¸æŠ: (${bestMove[0]}, ${bestMove[1]}) - ã‚¹ã‚³ã‚¢:${bestScore}`);
                return bestMove;
            }
            
            console.log("æœ‰åŠ¹ãªç¸¦2é€£ä½œæˆæ‰‹ãªã—");
            return null;
        }

        // â˜…è£œåŠ©é–¢æ•°â˜… ç¸¦2é€£åŠ¹æœè©•ä¾¡
        function evaluateVerticalDouble(row, col, player) {
            var score = 0;
            
            // ä¸‹æ–¹å‘ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆç¸¦ã«ç©ã¿é‡ã­ï¼‰
            if (row < GRID_HEIGHT - 1 && game.grid[row + 1][col] === player) {
                score += 80; // ç¸¦2é€£å®Œæˆ
                
                // ã•ã‚‰ã«ä¸‹ã«ã‚‚ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (row < GRID_HEIGHT - 2 && game.grid[row + 2][col] === player) {
                    score += 120; // ç¸¦3é€£ã«ãªã‚‹
                }
                
                // ä¸Šã«ä¼¸ã°ã›ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (row > 0 && game.grid[row - 1][col] === 0) {
                    score += 60; // ä¸Šã«ä¼¸ã°ã—å¯èƒ½
                }
            }
            
            // ä¸Šæ–¹å‘ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¢å­˜ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸Šã«ç©ã‚€ï¼‰
            if (row > 0 && game.grid[row - 1][col] === player) {
                score += 70; // ç¸¦2é€£ã«å‚åŠ 
                
                // ã•ã‚‰ã«ä¸Šã«ã‚‚ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (row > 1 && game.grid[row - 2][col] === player) {
                    score += 100; // ç¸¦3é€£ã«å‚åŠ 
                }
            }
            
            // æˆ¦ç•¥çš„ä½ç½®ãƒœãƒ¼ãƒŠã‚¹ï¼ˆä¸­å¤®ä»˜è¿‘ï¼‰
            var centerCol = Math.floor(GRID_WIDTH / 2);
            var distanceFromCenter = Math.abs(col - centerCol);
            score += Math.max(0, 20 - distanceFromCenter * 2);
            
            return score;
        }

        // â˜…ä¿®æ­£ç‰ˆâ˜… ç¸¦2é€£ + æœ¬å‘½æ”»æ’ƒæˆ¦ç•¥ï¼ˆçµ‚ç›¤30å€‹ä»¥ä¸Šé™å®šï¼‰
        function findVerticalDoublePlusThreatMove(player) {
            var gamePhase = getGamePhase();
            
            if (gamePhase !== 'late') {
                console.log(`ç¸¦2é€£+æœ¬å‘½æ”»æ’ƒ: ${gamePhase}ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ï¼ˆ30å€‹ä»¥ä¸Šã§ç™ºå‹•ï¼‰`);
                return null;
            }
            
            console.log(`ç¸¦2é€£+æœ¬å‘½æ”»æ’ƒæ¤œç´¢é–‹å§‹ - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${player} (çµ‚ç›¤æˆ¦ç•¥)`);
            
            // æ—¢å­˜ã®ç¸¦2é€£ã‚’æ¢ã™
            var verticalDoubles = [];
            for (var row = 0; row < GRID_HEIGHT - 1; row++) {
                for (var col = 0; col < GRID_WIDTH; col++) {
                    if (game.grid[row][col] === player && game.grid[row + 1][col] === player) {
                        // ä¸Šã«ä¼¸ã°ã›ã‚‹ç¸¦2é€£ã‚’ç™ºè¦‹
                        if (row > 0 && game.grid[row - 1][col] === 0 && isValidPlacement(row - 1, col)) {
                            verticalDoubles.push({
                                extendPos: [row - 1, col],
                                baseRow: row + 1,
                                score: 90
                            });
                        }
                    }
                }
            }
            
            if (verticalDoubles.length === 0) {
                console.log("æ´»ç”¨å¯èƒ½ãªç¸¦2é€£ãªã—");
                return null;
            }
            
            console.log(`æ´»ç”¨å¯èƒ½ãªç¸¦2é€£: ${verticalDoubles.length}å€‹ç™ºè¦‹`);
            
            // å„ç¸¦2é€£ã«ã¤ã„ã¦ã€åŒæ™‚æ”»æ’ƒå¯èƒ½ãªæœ¬å‘½ã‚’æ¢ã™
            var validMoves = getAllValidMoves();
            var bestComboMove = null;
            var bestComboScore = 0;
            
            for (var i = 0; i < validMoves.length; i++) {
                var move = validMoves[i];
                var row = move[0];
                var col = move[1];
                
                // ã“ã®æ‰‹ã‚’ç½®ã„ãŸå ´åˆã®è„…å¨ãƒ¬ãƒ™ãƒ«ã‚’è©•ä¾¡
                game.grid[row][col] = player;
                
                var threats = findConsecutiveBlocks(player, 2);
                var mainThreatScore = 0;
                
                for (var t = 0; t < threats.length; t++) {
                    mainThreatScore += evaluateThreat(threats[t], player);
                }
                
                game.grid[row][col] = 0;
                
                // ç¸¦2é€£ã¨ã®çµ„ã¿åˆã‚ã›åŠ¹æœã‚’è¨ˆç®—
                if (mainThreatScore > 200) { // æœ¬å‘½ã¨ã—ã¦ä¾¡å€¤ãŒã‚ã‚‹æ‰‹
                    for (var v = 0; v < verticalDoubles.length; v++) {
                        var vDouble = verticalDoubles[v];
                        
                        // åŒã˜ã‚¿ãƒ¼ãƒ³ã§å®Ÿè¡Œå¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆç•°ãªã‚‹ä½ç½®ã§ã‚ã‚‹å¿…è¦ï¼‰
                        if (row !== vDouble.extendPos[0] || col !== vDouble.extendPos[1]) {
                            var comboScore = mainThreatScore + vDouble.score + 150; // ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹
                            
                            if (comboScore > bestComboScore) {
                                bestComboScore = comboScore;
                                bestComboMove = move;
                            }
                        }
                    }
                }
            }
            
            if (bestComboMove && bestComboScore > 400) {
                console.log(`ç¸¦2é€£+æœ¬å‘½æ”»æ’ƒæ‰‹é¸æŠ: (${bestComboMove[0]}, ${bestComboMove[1]}) - ã‚³ãƒ³ãƒœã‚¹ã‚³ã‚¢:${bestComboScore}`);
                return bestComboMove;
            }
            
            console.log("æœ‰åŠ¹ãªç¸¦2é€£+æœ¬å‘½æ”»æ’ƒãªã—");
            return null;
        }

        // â˜…ä¿®æ­£ç‰ˆâ˜… ç›¸æ‰‹ã®ç¸¦2é€£é˜»æ­¢ï¼ˆçµ‚ç›¤30å€‹ä»¥ä¸Šé™å®šï¼‰
        function findVerticalDoubleBlock(player) {
            var opponent = player === 1 ? 2 : 1;
            var gamePhase = getGamePhase();
            
            if (gamePhase !== 'late') {
                console.log(`ç›¸æ‰‹ç¸¦2é€£é˜»æ­¢: ${gamePhase}ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ï¼ˆ30å€‹ä»¥ä¸Šã§ç™ºå‹•ï¼‰`);
                return null;
            }
            
            console.log(`ç›¸æ‰‹ç¸¦2é€£é˜»æ­¢æ¤œç´¢ - ç›¸æ‰‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${opponent} (çµ‚ç›¤æˆ¦ç•¥)`);
            
            var dangerousVerticalDoubles = [];
            
            // ç›¸æ‰‹ã®ç¸¦2é€£ã‚’æ¢ã™
            for (var row = 0; row < GRID_HEIGHT - 1; row++) {
                for (var col = 0; col < GRID_WIDTH; col++) {
                    if (game.grid[row][col] === opponent && game.grid[row + 1][col] === opponent) {
                        // ä¸Šã«ä¼¸ã°ã›ã‚‹ç›¸æ‰‹ã®ç¸¦2é€£ã‚’ç™ºè¦‹
                        if (row > 0 && game.grid[row - 1][col] === 0 && isValidPlacement(row - 1, col)) {
                            var dangerLevel = 120; // çµ‚ç›¤ã§ã¯é«˜å±é™ºåº¦
                            
                            // ä¸­å¤®ä»˜è¿‘ã¯ã‚ˆã‚Šå±é™º
                            var centerCol = Math.floor(GRID_WIDTH / 2);
                            var distanceFromCenter = Math.abs(col - centerCol);
                            dangerLevel += Math.max(0, 20 - distanceFromCenter * 2);
                            
                            dangerousVerticalDoubles.push({
                                blockPos: [row - 1, col],
                                danger: dangerLevel
                            });
                        }
                    }
                }
            }
            
            if (dangerousVerticalDoubles.length > 0) {
                // æœ€ã‚‚å±é™ºãªç¸¦2é€£ã‚’é˜»æ­¢
                dangerousVerticalDoubles.sort(function(a, b) { return b.danger - a.danger; });
                var mostDangerous = dangerousVerticalDoubles[0];
                
                console.log(`å±é™ºãªç›¸æ‰‹ç¸¦2é€£é˜»æ­¢: (${mostDangerous.blockPos[0]}, ${mostDangerous.blockPos[1]}) - å±é™ºåº¦:${mostDangerous.danger}`);
                return mostDangerous.blockPos;
            }
            
            console.log("é˜»æ­¢ã™ã¹ãç›¸æ‰‹ç¸¦2é€£ãªã—");
            return null;
        }

        // â˜…ä¿®æ­£ç‰ˆâ˜… ç¸¦2é€£ä½œæˆæˆ¦ç•¥ï¼ˆçµ‚ç›¤30å€‹ä»¥ä¸Šé™å®šï¼‰
        function findVerticalDoubleMove(player) {
            var gamePhase = getGamePhase();
            
            if (gamePhase !== 'late') {
                console.log(`ç¸¦2é€£ä½œæˆ: ${gamePhase}ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ï¼ˆ30å€‹ä»¥ä¸Šã§ç™ºå‹•ï¼‰`);
                return null;
            }
            
            console.log(`ç¸¦2é€£ä½œæˆæˆ¦ç•¥æ¤œç´¢é–‹å§‹ - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${player} (çµ‚ç›¤æˆ¦ç•¥)`);
            
            var validMoves = getAllValidMoves();
            var bestMove = null;
            var bestScore = 0;
            
            for (var i = 0; i < validMoves.length; i++) {
                var move = validMoves[i];
                var row = move[0];
                var col = move[1];
                
                // ã“ã®ä½ç½®ã«ç½®ã„ãŸå ´åˆã®ç¸¦2é€£åŠ¹æœã‚’è©•ä¾¡
                game.grid[row][col] = player;
                
                var verticalScore = evaluateVerticalDouble(row, col, player);
                
                game.grid[row][col] = 0;
                
                if (verticalScore > bestScore) {
                    bestScore = verticalScore;
                    bestMove = move;
                }
            }
            
            if (bestMove && bestScore > 50) {
                console.log(`ç¸¦2é€£ä½œæˆæ‰‹é¸æŠ: (${bestMove[0]}, ${bestMove[1]}) - ã‚¹ã‚³ã‚¢:${bestScore}`);
                return bestMove;
            }
            
            console.log("æœ‰åŠ¹ãªç¸¦2é€£ä½œæˆæ‰‹ãªã—");
            return null;
        }

        // â˜…æ–°è¦è¿½åŠ â˜… ç›¸æ‰‹ã®è¤‡æ•°è„…å¨ã‚’é˜»æ­¢
        function findMultipleThreatBlock(player) {
            var opponent = player === 1 ? 2 : 1;
            console.log(`ç›¸æ‰‹è¤‡æ•°è„…å¨é˜»æ­¢æ¤œç´¢ - ç›¸æ‰‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${opponent}`);
            
            // ç›¸æ‰‹ã®ç¾åœ¨ã®è„…å¨ã‚’è©•ä¾¡
            var opponentThreats = findConsecutiveBlocks(opponent, 3);
            if (opponentThreats.length < 2) {
                return null; // è¤‡æ•°è„…å¨ã§ãªã„
            }

            var totalDefenseRequired = 0;
            for (var i = 0; i < opponentThreats.length; i++) {
                totalDefenseRequired += calculateDefenseRequired(opponentThreats[i], opponent);
            }

            if (totalDefenseRequired >= 3) {
                console.log(`ç›¸æ‰‹ã®è¤‡æ•°è„…å¨æ¤œå‡º - é˜²å¾¡å¿…è¦æ•°:${totalDefenseRequired}`);
                
                // æœ€ã‚‚å±é™ºãªè„…å¨ã‚’é˜»æ­¢
                var mostDangerous = null;
                var maxScore = 0;
                
                for (var i = 0; i < opponentThreats.length; i++) {
                    var threat = opponentThreats[i];
                    var score = evaluateThreat(threat, opponent);
                    if (score > maxScore) {
                        maxScore = score;
                        mostDangerous = threat;
                    }
                }

                if (mostDangerous && mostDangerous.extendable.length > 0) {
                    var blockPos = mostDangerous.extendable[0];
                    if (isValidPlacement(blockPos[0], blockPos[1])) {
                        console.log(`è¤‡æ•°è„…å¨é˜»æ­¢æ‰‹: (${blockPos[0]}, ${blockPos[1]})`);
                        return blockPos;
                    }
                }
            }

            return null;
        }

        // â˜…ä¿®æ­£ç‰ˆâ˜… ç›¸æ‰‹ã®å‹åˆ©ã‚’é˜»æ­¢ã™ã‚‹æ‰‹ã‚’æ¢ã™
        function findBlockingMove(player) {
            var opponent = player === 1 ? 2 : 1;
            console.log(`é˜»æ­¢æ‰‹æ¤œç´¢é–‹å§‹ - ç›¸æ‰‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${opponent}ã®å‹åˆ©ã‚’é˜»æ­¢`);
            
            // ç¾åœ¨ã®winningCellsã‚’ä¿å­˜
            var originalWinningCells = game.winningCells.slice();
            
            for (var row = 0; row < GRID_HEIGHT; row++) {
                for (var col = 0; col < GRID_WIDTH; col++) {
                    if (game.grid[row][col] !== 0) continue;
                    if (!isValidPlacement(row, col)) continue;
                    
                    game.grid[row][col] = opponent;
                    var opponentWins = checkWin(row, col);
                    game.grid[row][col] = 0;
                    
                    if (opponentWins) {
                        console.log(`é˜»æ­¢æ‰‹ç™ºè¦‹: (${row}, ${col}) - ç›¸æ‰‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${opponent}ã®å‹åˆ©ã‚’é˜»æ­¢`);
                        // â˜…ä¿®æ­£â˜… æ¢ç´¢ã§æ±šæŸ“ã•ã‚ŒãŸwinningCellsã‚’å¾©å…ƒ
                        game.winningCells = originalWinningCells;
                        return [row, col];
                    }
                }
            }
            
            // â˜…ä¿®æ­£â˜… æ¢ç´¢ã§æ±šæŸ“ã•ã‚ŒãŸwinningCellsã‚’å¾©å…ƒ
            game.winningCells = originalWinningCells;
            console.log("é˜»æ­¢æ‰‹ãªã—");
            return null;
        }

        // â˜…æ–°è¦è¿½åŠ â˜… 3é€£è„…å¨ã‚’æ¤œå‡ºãƒ»é˜»æ­¢ã™ã‚‹å°‚ç”¨é–¢æ•°
        function findThreeInARowThreat(player) {
            var opponent = player === 1 ? 2 : 1;
            console.log(`3é€£è„…å¨æ¤œç´¢é–‹å§‹ - ç›¸æ‰‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${opponent}`);
            
            var originalWinningCells = game.winningCells.slice();
            var threats = [];

            // ç›¸æ‰‹ã®3é€£ä»¥ä¸Šã‚’æ¢ã™
            var consecutiveBlocks = findConsecutiveBlocks(opponent, 3);
            
            for (var i = 0; i < consecutiveBlocks.length; i++) {
                var blockInfo = consecutiveBlocks[i];
                var line = blockInfo.line;
                var direction = blockInfo.direction;
                var extendable = blockInfo.extendable;
                var isGround = blockInfo.isGround;

                // è„…å¨ãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—
                var threatLevel = 0;
                var blockPositions = [];

                if (line.length === 3) {
                    if (direction === 1) {
                        // ç¸¦3é€£ - æ¬¡ã‚¿ãƒ¼ãƒ³ã§ç¢ºå®Ÿã«5é€£ï¼ˆä¸Šã«2å€‹ç½®ã‘ã‚‹ï¼‰
                        console.log(`å±é™ºãªç¸¦3é€£æ¤œå‡º:`, line);
                        threatLevel = 900;
                        
                        // ä¸Šç«¯ã‚’é˜»æ­¢
                        for (var j = 0; j < extendable.length; j++) {
                            var pos = extendable[j];
                            if (pos[0] < line[0][0]) { // ã‚ˆã‚Šä¸Šã®ä½ç½®
                                if (isValidPlacement(pos[0], pos[1])) {
                                    blockPositions.push(pos);
                                }
                            }
                        }
                    } else if (direction === 0 && isGround) {
                        // åœ°é¢æ¨ª3é€£ - æ¬¡ã‚¿ãƒ¼ãƒ³ã§ç¢ºå®Ÿã«5é€£ï¼ˆä¸¡ç«¯ã«1å€‹ãšã¤ï¼‰
                        console.log(`å±é™ºãªåœ°é¢æ¨ª3é€£æ¤œå‡º:`, line);
                        threatLevel = 950;
                        
                        // ä¸¡ç«¯ã‚’é˜»æ­¢ãƒã‚¤ãƒ³ãƒˆã«è¿½åŠ 
                        for (var j = 0; j < extendable.length; j++) {
                            var pos = extendable[j];
                            if (isValidPlacement(pos[0], pos[1])) {
                                blockPositions.push(pos);
                            }
                        }
                    } else if (direction === 0) {
                        // é€šå¸¸ã®æ¨ª3é€£
                        console.log(`æ¨ª3é€£æ¤œå‡º:`, line);
                        threatLevel = 700;
                        
                        for (var j = 0; j < extendable.length; j++) {
                            var pos = extendable[j];
                            if (isValidPlacement(pos[0], pos[1])) {
                                blockPositions.push(pos);
                            }
                        }
                    } else {
                        // æ–œã‚3é€£
                        console.log(`æ–œã‚3é€£æ¤œå‡º:`, line);
                        threatLevel = 600;
                        
                        for (var j = 0; j < extendable.length; j++) {
                            var pos = extendable[j];
                            if (isValidPlacement(pos[0], pos[1])) {
                                blockPositions.push(pos);
                            }
                        }
                    }
                } else if (line.length === 4) {
                    // 4é€£ã¯æœ€é«˜è„…å¨
                    console.log(`æ¥µã‚ã¦å±é™ºãª4é€£æ¤œå‡º:`, line);
                    threatLevel = 1000;
                    
                    for (var j = 0; j < extendable.length; j++) {
                        var pos = extendable[j];
                        if (isValidPlacement(pos[0], pos[1])) {
                            blockPositions.push(pos);
                        }
                    }
                }

                if (blockPositions.length > 0) {
                    threats.push({
                        level: threatLevel,
                        positions: blockPositions,
                        type: direction === 1 ? 'ç¸¦' : (direction === 0 ? (isGround ? 'åœ°é¢æ¨ª' : 'æ¨ª') : 'æ–œã‚'),
                        length: line.length
                    });
                }
            }

            game.winningCells = originalWinningCells;

            // æœ€ã‚‚å±é™ºãªè„…å¨ã‚’å„ªå…ˆã—ã¦é˜»æ­¢
            if (threats.length > 0) {
                // è„…å¨ãƒ¬ãƒ™ãƒ«ã§ã‚½ãƒ¼ãƒˆ
                threats.sort(function(a, b) { return b.level - a.level; });
                
                var topThreat = threats[0];
                console.log(`æœ€å„ªå…ˆè„…å¨: ${topThreat.type}${topThreat.length}é€£ (è„…å¨ãƒ¬ãƒ™ãƒ«:${topThreat.level})`);
                
                // æœ€é©ãªé˜»æ­¢ä½ç½®ã‚’é¸æŠ
                var blockPos = topThreat.positions[0];
                console.log(`3é€£è„…å¨é˜»æ­¢æ‰‹: (${blockPos[0]}, ${blockPos[1]})`);
                return blockPos;
            }

            console.log("3é€£è„…å¨ãªã—");
            return null;
        }

        // ä¸­å¤®ä»˜è¿‘ã®ä¾¡å€¤ã®é«˜ã„æ‰‹ã‚’æ¢ã™
        function findCenterMove() {
            console.log("ä¸­å¤®åˆ¶åœ§æ‰‹æ¤œç´¢é–‹å§‹");
            
            var centerCol = Math.floor(GRID_WIDTH / 2);
            var validMoves = getAllValidMoves();
            
            if (validMoves.length === 0) {
                console.log("ä¸­å¤®åˆ¶åœ§æ‰‹ãªã— - æœ‰åŠ¹æ‰‹ãŒ0å€‹");
                return null;
            }
            
            validMoves.sort(function(a, b) {
                var distA = Math.abs(a[1] - centerCol);
                var distB = Math.abs(b[1] - centerCol);
                return distA - distB;
            });
            
            console.log(`ä¸­å¤®åˆ¶åœ§æ‰‹é¸æŠ: (${validMoves[0][0]}, ${validMoves[0][1]}) - ä¸­å¤®ã‹ã‚‰ã®è·é›¢: ${Math.abs(validMoves[0][1] - centerCol)}`);
            return validMoves[0];
        }

        // â˜…ä¿®æ­£ç‰ˆâ˜… 2æ‰‹å‹åˆ©ã®å¯èƒ½æ€§ã‚’æ¢ã™
        function findTwoMoveWin(player) {
            console.log(`2æ‰‹å‹åˆ©æ¤œç´¢é–‹å§‹ - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${player}`);
            
            // ç¾åœ¨ã®winningCellsã‚’ä¿å­˜
            var originalWinningCells = game.winningCells.slice();
            
            var validMoves = getAllValidMoves();
            
            for (var i = 0; i < validMoves.length; i++) {
                var move = validMoves[i];
                var row = move[0];
                var col = move[1];
                
                game.grid[row][col] = player;
                
                var hasWinningFollow = false;
                for (var row2 = 0; row2 < GRID_HEIGHT; row2++) {
                    for (var col2 = 0; col2 < GRID_WIDTH; col2++) {
                        if (game.grid[row2][col2] !== 0) continue;
                        if (!isValidPlacement(row2, col2)) continue;
                        
                        game.grid[row2][col2] = player;
                        var canWin = checkWin(row2, col2);
                        game.grid[row2][col2] = 0;
                        
                        if (canWin) {
                            hasWinningFollow = true;
                            break;
                        }
                    }
                    if (hasWinningFollow) break;
                }
                
                game.grid[row][col] = 0;
                
                if (hasWinningFollow) {
                    console.log(`2æ‰‹å‹åˆ©ã®èµ·ç‚¹ç™ºè¦‹: (${row}, ${col}) - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${player}`);
                    // â˜…ä¿®æ­£â˜… æ¢ç´¢ã§æ±šæŸ“ã•ã‚ŒãŸwinningCellsã‚’å¾©å…ƒ
                    game.winningCells = originalWinningCells;
                    return [row, col];
                }
            }
            
            // â˜…ä¿®æ­£â˜… æ¢ç´¢ã§æ±šæŸ“ã•ã‚ŒãŸwinningCellsã‚’å¾©å…ƒ
            game.winningCells = originalWinningCells;
            console.log("2æ‰‹å‹åˆ©ãªã—");
            return null;
        }

        // â˜…LEVEL4å°‚ç”¨â˜… é€£ç¶šãƒ–ãƒ­ãƒƒã‚¯æ¤œå‡º
        function findConsecutiveBlocks(player, length) {
            var results = [];
            var directions = [
                [0, 1],  // æ¨ª
                [1, 0],  // ç¸¦
                [1, 1],  // æ–œã‚å³ä¸‹
                [1, -1]  // æ–œã‚å·¦ä¸‹
            ];

            for (var row = 0; row < GRID_HEIGHT; row++) {
                for (var col = 0; col < GRID_WIDTH; col++) {
                    if (game.grid[row][col] !== player) continue;

                    for (var d = 0; d < directions.length; d++) {
                        var dr = directions[d][0];
                        var dc = directions[d][1];
                        var line = [[row, col]];
                        
                        // æ­£æ–¹å‘ã«å»¶ã°ã™
                        for (var i = 1; i < WIN_COUNT; i++) {
                            var r = row + dr * i;
                            var c = col + dc * i;
                            if (r >= 0 && r < GRID_HEIGHT && c >= 0 && c < GRID_WIDTH && 
                                game.grid[r][c] === player) {
                                line.push([r, c]);
                            } else {
                                break;
                            }
                        }

                        if (line.length >= length) {
                            // å»¶é•·å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
                            var extendable = [];
                            
                            // å‰æ–¹
                            var frontR = row - dr;
                            var frontC = col - dc;
                            if (frontR >= 0 && frontR < GRID_HEIGHT && frontC >= 0 && frontC < GRID_WIDTH && 
                                game.grid[frontR][frontC] === 0) {
                                extendable.push([frontR, frontC]);
                            }
                            
                            // å¾Œæ–¹
                            var backR = row + dr * line.length;
                            var backC = col + dc * line.length;
                            if (backR >= 0 && backR < GRID_HEIGHT && backC >= 0 && backC < GRID_WIDTH && 
                                game.grid[backR][backC] === 0) {
                                extendable.push([backR, backC]);
                            }

                            results.push({
                                line: line,
                                direction: d,
                                extendable: extendable,
                                isGround: row === GRID_HEIGHT - 1 || (row + dr * (line.length - 1)) === GRID_HEIGHT - 1
                            });
                        }
                    }
                }
            }

            return results;
        }

        // â˜…LEVEL4å°‚ç”¨â˜… è„…å¨è©•ä¾¡
        function evaluateThreat(consecutiveInfo, player) {
            var length = consecutiveInfo.line.length;
            var extendable = consecutiveInfo.extendable;
            var isGround = consecutiveInfo.isGround;
            var direction = consecutiveInfo.direction;

            var score = 0;

            if (length === 4) {
                // 4é€£ã¯æœ€é«˜è„…å¨
                score = 1000;
                if (extendable.length >= 1) {
                    score += 500; // å»¶é•·å¯èƒ½
                }
            } else if (length === 3) {
                if (direction === 1) { // ç¸¦
                    // ç¸¦3é€£ã¯æ¬¡ã‚¿ãƒ¼ãƒ³ã§ç¢ºå®Ÿã«5é€£
                    score = 800;
                } else if (direction === 0 && isGround) {
                    // åœ°é¢ãƒ¬ãƒ™ãƒ«ã®æ¨ª3é€£ã¯ä¸¡ç«¯é˜²å¾¡å¿…é ˆ
                    score = 850;
                } else if (direction === 0) {
                    // æ¨ª3é€£
                    if (extendable.length >= 2) {
                        score = 700; // ä¸¡ç«¯å»¶é•·å¯èƒ½
                    } else if (extendable.length === 1) {
                        score = 500; // ç‰‡ç«¯ã®ã¿
                    }
                } else {
                    // æ–œã‚3é€£
                    if (extendable.length >= 2) {
                        score = 600;
                    } else if (extendable.length === 1) {
                        score = 400;
                    }
                }
            } else if (length === 2) {
                score = length * 10; // åŸºæœ¬ã‚¹ã‚³ã‚¢
            }

            return score;
        }

        // â˜…LEVEL4å°‚ç”¨â˜… é˜²å¾¡å¿…è¦æ•°è¨ˆç®—
        function calculateDefenseRequired(consecutiveInfo, player) {
            var length = consecutiveInfo.line.length;
            var extendable = consecutiveInfo.extendable;
            var direction = consecutiveInfo.direction;
            var isGround = consecutiveInfo.isGround;

            if (length === 4) {
                // 4é€£ã®é˜²å¾¡
                var requiredBlocks = 0;
                for (var i = 0; i < extendable.length; i++) {
                    var pos = extendable[i];
                    if (isValidPlacement(pos[0], pos[1])) {
                        requiredBlocks++;
                    }
                }
                return Math.min(requiredBlocks, 2); // æœ€å¤§2å€‹ã¾ã§
            } else if (length === 3) {
                if (direction === 1) { // ç¸¦3é€£
                    return 1; // ä¸Šã«1å€‹ç½®ã‘ã°é˜²å¾¡å¯èƒ½
                } else if (direction === 0 && isGround) {
                    // åœ°é¢ã®æ¨ª3é€£ã¯ä¸¡ç«¯é˜²å¾¡å¿…è¦
                    return 2;
                } else {
                    // ãã®ä»–ã®3é€£
                    var validExtendable = 0;
                    for (var i = 0; i < extendable.length; i++) {
                        var pos = extendable[i];
                        if (isValidPlacement(pos[0], pos[1])) {
                            validExtendable++;
                        }
                    }
                    return Math.min(validExtendable, 2);
                }
            }

            return 1; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        }

        // â˜…LEVEL4å°‚ç”¨â˜… è¤‡æ•°è„…å¨ä½œæˆæ‰‹ã‚’æ¢ã™
        function findMultipleThreatMove(player) {
            console.log(`è¤‡æ•°è„…å¨æ¤œç´¢é–‹å§‹ - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${player}`);
            
            var originalWinningCells = game.winningCells.slice();
            var validMoves = getAllValidMoves();
            var bestMove = null;
            var maxThreats = 0;

            for (var i = 0; i < validMoves.length; i++) {
                var move = validMoves[i];
                var row = move[0];
                var col = move[1];

                // æ‰‹ã‚’è©¦ã™
                game.grid[row][col] = player;

                // ã“ã®æ‰‹ã§ä½œã‚‰ã‚Œã‚‹è„…å¨ã‚’è©•ä¾¡
                var threats = findConsecutiveBlocks(player, 3);
                var totalThreatScore = 0;
                var defenseRequired = 0;

                for (var t = 0; t < threats.length; t++) {
                    var threat = threats[t];
                    totalThreatScore += evaluateThreat(threat, player);
                    defenseRequired += calculateDefenseRequired(threat, player);
                }

                // è¤‡æ•°è„…å¨ã‹ã¤é˜²å¾¡ã«3å€‹ä»¥ä¸Šå¿…è¦ãªã‚‰å„ªç§€
                if (threats.length >= 2 && defenseRequired >= 3) {
                    console.log(`è¤‡æ•°è„…å¨ç™ºè¦‹: (${row}, ${col}) - è„…å¨æ•°:${threats.length}, é˜²å¾¡å¿…è¦æ•°:${defenseRequired}`);
                    
                    if (defenseRequired > maxThreats || (defenseRequired === maxThreats && totalThreatScore > 0)) {
                        maxThreats = defenseRequired;
                        bestMove = [row, col];
                    }
                }

                // æ‰‹ã‚’æˆ»ã™
                game.grid[row][col] = 0;
            }

            game.winningCells = originalWinningCells;
            
            if (bestMove) {
                console.log(`è¤‡æ•°è„…å¨æ‰‹é¸æŠ: (${bestMove[0]}, ${bestMove[1]}) - é˜²å¾¡å¿…è¦æ•°:${maxThreats}`);
            } else {
                console.log("è¤‡æ•°è„…å¨æ‰‹ãªã—");
            }
            
            return bestMove;
        }

        // â˜…LEVEL4å°‚ç”¨â˜… é«˜è„…å¨æ‰‹ã‚’æ¢ã™
        function findHighThreatMove(player) {
            console.log(`é«˜è„…å¨æ‰‹æ¤œç´¢é–‹å§‹ - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${player}`);
            
            var originalWinningCells = game.winningCells.slice();
            var validMoves = getAllValidMoves();
            var bestMove = null;
            var maxScore = 0;

            for (var i = 0; i < validMoves.length; i++) {
                var move = validMoves[i];
                var row = move[0];
                var col = move[1];

                // æ‰‹ã‚’è©¦ã™
                game.grid[row][col] = player;

                // ã“ã®æ‰‹ã§ä½œã‚‰ã‚Œã‚‹è„…å¨ã‚’è©•ä¾¡
                var threats = findConsecutiveBlocks(player, 2);
                var totalScore = 0;

                for (var t = 0; t < threats.length; t++) {
                    totalScore += evaluateThreat(threats[t], player);
                }

                if (totalScore > maxScore) {
                    maxScore = totalScore;
                    bestMove = [row, col];
                }

                // æ‰‹ã‚’æˆ»ã™
                game.grid[row][col] = 0;
            }

            game.winningCells = originalWinningCells;
            
            if (bestMove && maxScore > 100) {
                console.log(`é«˜è„…å¨æ‰‹é¸æŠ: (${bestMove[0]}, ${bestMove[1]}) - ã‚¹ã‚³ã‚¢:${maxScore}`);
                return bestMove;
            }
            
            console.log("æœ‰åŠ¹ãªé«˜è„…å¨æ‰‹ãªã—");
            return null;
        }

        // â˜…LEVEL4å°‚ç”¨â˜… ç›¸æ‰‹ã®è¤‡æ•°è„…å¨ã‚’é˜»æ­¢
        function findMultipleThreatBlock(player) {
            var opponent = player === 1 ? 2 : 1;
            console.log(`ç›¸æ‰‹è¤‡æ•°è„…å¨é˜»æ­¢æ¤œç´¢ - ç›¸æ‰‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${opponent}`);
            
            // ç›¸æ‰‹ã®ç¾åœ¨ã®è„…å¨ã‚’è©•ä¾¡
            var opponentThreats = findConsecutiveBlocks(opponent, 3);
            if (opponentThreats.length < 2) {
                return null; // è¤‡æ•°è„…å¨ã§ãªã„
            }

            var totalDefenseRequired = 0;
            for (var i = 0; i < opponentThreats.length; i++) {
                totalDefenseRequired += calculateDefenseRequired(opponentThreats[i], opponent);
            }

            if (totalDefenseRequired >= 3) {
                console.log(`ç›¸æ‰‹ã®è¤‡æ•°è„…å¨æ¤œå‡º - é˜²å¾¡å¿…è¦æ•°:${totalDefenseRequired}`);
                
                // æœ€ã‚‚å±é™ºãªè„…å¨ã‚’é˜»æ­¢
                var mostDangerous = null;
                var maxScore = 0;
                
                for (var i = 0; i < opponentThreats.length; i++) {
                    var threat = opponentThreats[i];
                    var score = evaluateThreat(threat, opponent);
                    if (score > maxScore) {
                        maxScore = score;
                        mostDangerous = threat;
                    }
                }

                if (mostDangerous && mostDangerous.extendable.length > 0) {
                    var blockPos = mostDangerous.extendable[0];
                    if (isValidPlacement(blockPos[0], blockPos[1])) {
                        console.log(`è¤‡æ•°è„…å¨é˜»æ­¢æ‰‹: (${blockPos[0]}, ${blockPos[1]})`);
                        return blockPos;
                    }
                }
            }

            return null;
        }

        // â˜…ä¿®æ­£ç‰ˆâ˜… ãƒ–ãƒ­ãƒƒã‚¯é…ç½®å‡¦ç†
        function placePiece(row, col, isAIMove) {
            try {
                // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                if (row < 0 || row >= GRID_HEIGHT || col < 0 || col >= GRID_WIDTH) {
                    return;
                }
                
                if (!game.gameActive || game.animating || game.remainingBlocks <= 0) {
                    return;
                }
                
                if (game.isAI && game.currentPlayer === game.aiPlayer && !isAIMove) {
                    return;
                }
                
                if (game.grid[row][col] !== 0) {
                    if (!isAIMove) {
                        showAlert("ãã®ãƒã‚¹ã«ã¯æ—¢ã«ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚Šã¾ã™ï¼");
                    }
                    return;
                }
                
                if (row < GRID_HEIGHT - 1 && game.grid[row + 1][col] === 0) {
                    if (!isAIMove) {
                        showAlert("ã“ã®ä½ç½®ã«ã¯ä¸‹ã«æ”¯ãˆãŒã‚ã‚Šã¾ã›ã‚“ï¼");
                    }
                    return;
                }
                
                if (row === GRID_HEIGHT - 1 && !isValidGroundPlacement(col)) {
                    if (!isAIMove) {
                        showAlert("åœ°é¢ã«ç½®ãã«ã¯éš£æ¥ãƒ–ãƒ­ãƒƒã‚¯ãŒå¿…è¦ã§ã™ï¼");
                    }
                    return;
                }
                
                // é…ç½®å®Ÿè¡Œ
                game.animating = true;
                
                setTimeout(function () {
                    game.grid[row][col] = game.currentPlayer;
                    game.remainingBlocks--;
                    
                    console.log(`ãƒ–ãƒ­ãƒƒã‚¯é…ç½®å®Œäº† - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${game.currentPlayer}, æ®‹ã‚Š${game.remainingBlocks}å€‹`);
                    
                    // â˜…ä¿®æ­£â˜… å‹åˆ©åˆ¤å®š
                    if (checkWin(row, col)) {
                        game.showingWin = true; // â˜…ä¿®æ­£â˜… å‹åˆ©ç¢ºå®šãƒ•ãƒ©ã‚°ã‚’è¨­å®š
                        console.log("å‹åˆ©ç¢ºå®šï¼å‹åˆ©ãƒ©ã‚¤ãƒ³è¡¨ç¤ºé–‹å§‹");
                        
                        showWinningCells(); // â˜…ä¿®æ­£â˜… ã“ã®é–¢æ•°ã¯å®šç¾©æ¸ˆã¿
                        updateGrid(); // é»„è‰²ã„æ ã‚’å«ã‚ã¦ç”»é¢æ›´æ–°
                        
                        setTimeout(function() {
                            endGame(game.currentPlayer);
                        }, 3000); // 3ç§’é–“é»„è‰²ã„æ ã‚’è¡¨ç¤ºã—ã¦ã‹ã‚‰ã‚²ãƒ¼ãƒ çµ‚äº†
                        return;
                    }
                    
                    // ã‚¿ãƒ¼ãƒ³çµ‚äº†å‡¦ç†
                    if (game.remainingBlocks <= 0) {
                        setTimeout(function () {
                            clearInterval(game.timer);
                            
                            // ã‚¿ãƒ¼ãƒ³äº¤ä»£
                            game.currentPlayer = game.currentPlayer === 1 ? 2 : 1;
                            game.turnCount++;
                            
                            // ãƒ–ãƒ­ãƒƒã‚¯æ•°è¨­å®š
                            game.remainingBlocks = game.turnCount === 1 ? BLOCKS_PER_TURN : BLOCKS_PER_TURN;
                            
                            // ã‚¿ã‚¤ãƒãƒ¼è¨­å®š
                            if (game.turnCount === 0) {
                                game.timeLeft = 30;
                            } else if (game.turnCount === 1) {
                                game.timeLeft = 45;
                            } else {
                                game.timeLeft = 60;
                            }
                            
                            console.log(`ã‚¿ãƒ¼ãƒ³äº¤ä»£ - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${game.currentPlayer}, ã‚¿ãƒ¼ãƒ³${game.turnCount}`);
                            
                            startTimer();
                            updateDisplay();
                            
                            // AIã®ã‚¿ãƒ¼ãƒ³
                            if (game.isAI && game.currentPlayer === game.aiPlayer) {
                                setTimeout(cpuPlay, 800);
                            }
                        }, 500);
                    }
                    
                    game.animating = false;
                    updateDisplay();
                    
                    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ‹¡å¼µãƒã‚§ãƒƒã‚¯
                    checkAndExtendGrid();
                    
                }, 300);
                
            } catch (error) {
                console.error("ãƒ–ãƒ­ãƒƒã‚¯é…ç½®ã§ã‚¨ãƒ©ãƒ¼:", error);
                game.animating = false;
                showAlert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
            }
        }

        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ‹¡å¼µæ©Ÿèƒ½
        function checkAndExtendGrid() {
            var needsUpdate = false;

            // å·¦ç«¯ãƒã‚§ãƒƒã‚¯ï¼ˆ0åˆ—ç›®ã«ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚‹å ´åˆï¼‰
            for (var row = 0; row < GRID_HEIGHT; row++) {
                if (game.grid[row][0] !== 0) {
                    console.log("å·¦ç«¯æ‹¡å¼µå®Ÿè¡Œ");
                    extendGridLeft();
                    needsUpdate = true;
                    break;
                }
            }

            // å³ç«¯ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¾Œã®åˆ—ã«ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚‹å ´åˆï¼‰
            for (var row = 0; row < GRID_HEIGHT; row++) {
                if (game.grid[row][GRID_WIDTH - 1] !== 0) {
                    console.log("å³ç«¯æ‹¡å¼µå®Ÿè¡Œ");
                    extendGridRight();
                    needsUpdate = true;
                    break;
                }
            }

            // ä¸Šç«¯ãƒã‚§ãƒƒã‚¯ï¼ˆ0è¡Œç›®ã«ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚‹å ´åˆï¼‰
            for (var col = 0; col < GRID_WIDTH; col++) {
                if (game.grid[0][col] !== 0) {
                    console.log("ä¸Šç«¯æ‹¡å¼µå®Ÿè¡Œ");
                    extendGridTop();
                    needsUpdate = true;
                    break;
                }
            }

            // æ‹¡å¼µã—ãŸå ´åˆã¯ã‚°ãƒªãƒƒãƒ‰ã‚’å†ä½œæˆ
            if (needsUpdate) {
                createGrid();
                updateDisplay();
            }
        }

        function extendGridLeft() {
            // å„è¡Œã®å…ˆé ­ã«ç©ºã®ã‚»ãƒ«ã‚’è¿½åŠ 
            for (var row = 0; row < GRID_HEIGHT; row++) {
                game.grid[row].unshift(0);
            }
            GRID_WIDTH++;
            console.log(`å·¦æ‹¡å¼µå®Œäº† - æ–°ã‚µã‚¤ã‚º: ${GRID_WIDTH}x${GRID_HEIGHT}`);
        }

        function extendGridRight() {
            // å„è¡Œã®æœ«å°¾ã«ç©ºã®ã‚»ãƒ«ã‚’è¿½åŠ 
            for (var row = 0; row < GRID_HEIGHT; row++) {
                game.grid[row].push(0);
            }
            GRID_WIDTH++;
            console.log(`å³æ‹¡å¼µå®Œäº† - æ–°ã‚µã‚¤ã‚º: ${GRID_WIDTH}x${GRID_HEIGHT}`);
        }

        function extendGridTop() {
            // ä¸Šã«æ–°ã—ã„è¡Œã‚’è¿½åŠ 
            var newRow = new Array(GRID_WIDTH).fill(0);
            game.grid.unshift(newRow);
            GRID_HEIGHT++;
            console.log(`ä¸Šæ‹¡å¼µå®Œäº† - æ–°ã‚µã‚¤ã‚º: ${GRID_WIDTH}x${GRID_HEIGHT}`);
        }

        function updateGridTemplate() {
            var gridElement = document.getElementById('gameGrid');
            if (gridElement) {
                gridElement.style.gridTemplateColumns = `repeat(${GRID_WIDTH}, 32px)`;
            }
        }

        function cpuPlay() {
            if (!game.gameActive || game.currentPlayer !== game.aiPlayer || !game.isAI || game.showingWin) {
                console.log("AIå‹•ä½œåœæ­¢");
                return;
            }

            console.log(`AIå‹•ä½œé–‹å§‹ Lv${aiLevel} - é…ç½®äºˆå®šãƒ–ãƒ­ãƒƒã‚¯æ•°:`, game.remainingBlocks);
            
            game.aiThinking = true;
            
            let placed = 0;
            const maxBlocks = game.remainingBlocks;

            function placeOneBlock() {
                if (placed >= maxBlocks || !game.gameActive || game.currentPlayer !== game.aiPlayer) {
                    console.log("AIé…ç½®å®Œäº†");
                    game.aiThinking = false;
                    return;
                }

                let chosenMove = null;

                // ãƒ¬ãƒ™ãƒ«åˆ¥AIå®Ÿè£…
                if (aiLevel === 1) {
                    // ãƒ¬ãƒ™ãƒ«1: ãƒ©ãƒ³ãƒ€ãƒ 
                    chosenMove = getRandomMove();
                    console.log("Lv1ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰æˆ¦ç•¥ã§æ‰‹ã‚’é¸æŠ");
                    
                } else if (aiLevel === 2) {
                    // ãƒ¬ãƒ™ãƒ«2: å³åº§è„…å¨å¯¾å¿œå‹
                    console.log("=== ãƒ¬ãƒ™ãƒ«2AIå‹•ä½œé–‹å§‹ ===");
                    
                    try {
                        var winMove = findWinningMove(game.aiPlayer);
                        
                        if (winMove) {
                            console.log("ãƒ¬ãƒ™ãƒ«2: å‹åˆ©æ‰‹é¸æŠ");
                            chosenMove = winMove;
                        } else {
                            var blockMove = findBlockingMove(game.aiPlayer);
                            
                            if (blockMove) {
                                console.log("ãƒ¬ãƒ™ãƒ«2: é˜»æ­¢æ‰‹é¸æŠ");
                                chosenMove = blockMove;
                            } else {
                                chosenMove = getRandomMove();
                                console.log("ãƒ¬ãƒ™ãƒ«2: ãƒ©ãƒ³ãƒ€ãƒ æ‰‹é¸æŠ");
                            }
                        }
                    } catch (error) {
                        console.error("ãƒ¬ãƒ™ãƒ«2AIå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:", error);
                        chosenMove = getRandomMove();
                    }
                    
                } else if (aiLevel === 3) {
                    // ãƒ¬ãƒ™ãƒ«3: æˆ¦è¡“çš„æ€è€ƒå‹
                    console.log("=== ãƒ¬ãƒ™ãƒ«3AIå‹•ä½œé–‹å§‹ ===");
                    
                    try {
                        var winMove = findWinningMove(game.aiPlayer);
                        
                        if (winMove) {
                            console.log("ãƒ¬ãƒ™ãƒ«3: å‹åˆ©æ‰‹é¸æŠ");
                            chosenMove = winMove;
                        } else {
                            var blockMove = findBlockingMove(game.aiPlayer);
                            
                            if (blockMove) {
                                console.log("ãƒ¬ãƒ™ãƒ«3: é˜»æ­¢æ‰‹é¸æŠ");
                                chosenMove = blockMove;
                            } else {
                                var twoMoveWin = findTwoMoveWin(game.aiPlayer);
                                
                                if (twoMoveWin) {
                                    console.log("ãƒ¬ãƒ™ãƒ«3: 2æ‰‹å‹åˆ©æ‰‹é¸æŠ");
                                    chosenMove = twoMoveWin;
                                } else {
                                    var opponent = game.aiPlayer === 1 ? 2 : 1;
                                    var opponentTwoMoveWin = findTwoMoveWin(opponent);
                                    
                                    if (opponentTwoMoveWin) {
                                        console.log("ãƒ¬ãƒ™ãƒ«3: ç›¸æ‰‹2æ‰‹å‹åˆ©é˜»æ­¢");
                                        chosenMove = opponentTwoMoveWin;
                                    } else {
                                        var centerMove = findCenterMove();
                                        
                                        if (centerMove) {
                                            console.log("ãƒ¬ãƒ™ãƒ«3: ä¸­å¤®åˆ¶åœ§æ‰‹é¸æŠ");
                                            chosenMove = centerMove;
                                        } else {
                                            chosenMove = getRandomMove();
                                        }
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error("ãƒ¬ãƒ™ãƒ«3AIå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:", error);
                        chosenMove = getRandomMove();
                    }
                    
                } else if (aiLevel === 4) {
                    // ãƒ¬ãƒ™ãƒ«4: é«˜åº¦æˆ¦è¡“AIï¼ˆé˜²å¾¡æœ€å„ªå…ˆæˆ¦ç•¥ï¼‰
                    console.log("=== ãƒ¬ãƒ™ãƒ«4AIå‹•ä½œé–‹å§‹ï¼ˆé˜²å¾¡æœ€å„ªå…ˆï¼‰===");
                    
                    try {
                        // 1. å³åº§å‹åˆ©æ‰‹ï¼ˆå‹ã¦ã‚‹ãªã‚‰å‹ã¤ï¼‰
                        console.log("ãƒ¬ãƒ™ãƒ«4: å‹åˆ©æ‰‹æ¤œç´¢ä¸­...");
                        var winMove = findWinningMove(game.aiPlayer);
                        
                        if (winMove) {
                            console.log("ãƒ¬ãƒ™ãƒ«4: å³åº§å‹åˆ©æ‰‹é¸æŠ");
                            chosenMove = winMove;
                        } else {
                            // 2. ç›¸æ‰‹ã®å³åº§å‹åˆ©é˜»æ­¢ï¼ˆ1æ‰‹å‹åˆ©é˜²å¾¡ï¼‰
                            console.log("ãƒ¬ãƒ™ãƒ«4: å³åº§å‹åˆ©é˜»æ­¢æ¤œç´¢ä¸­...");
                            var blockMove = findBlockingMove(game.aiPlayer);
                            
                            if (blockMove) {
                                console.log("ãƒ¬ãƒ™ãƒ«4: ç›¸æ‰‹å³åº§å‹åˆ©é˜»æ­¢");
                                chosenMove = blockMove;
                            } else {
                                // 3. â˜…æœ€å„ªå…ˆé˜²å¾¡â˜… 4é€£ç·Šæ€¥é˜»æ­¢
                                console.log("ãƒ¬ãƒ™ãƒ«4: 4é€£ç·Šæ€¥é˜»æ­¢æ¤œç´¢ä¸­...");
                                var fourRowThreat = findFourInARowThreat(game.aiPlayer);
                                
                                if (fourRowThreat) {
                                    console.log("ãƒ¬ãƒ™ãƒ«4: â˜…ç·Šæ€¥â˜… 4é€£é˜»æ­¢æ‰‹é¸æŠ");
                                    chosenMove = fourRowThreat;
                                } else {
                                    // 4. 3é€£è„…å¨é˜»æ­¢ï¼ˆåœ°é¢3é€£ã€ç¸¦3é€£ãªã©ï¼‰
                                    console.log("ãƒ¬ãƒ™ãƒ«4: 3é€£è„…å¨é˜»æ­¢æ¤œç´¢ä¸­...");
                                    var threatBlockMove = findThreeInARowThreat(game.aiPlayer);
                                    
                                    if (threatBlockMove) {
                                        console.log("ãƒ¬ãƒ™ãƒ«4: 3é€£è„…å¨é˜»æ­¢æ‰‹é¸æŠ");
                                        chosenMove = threatBlockMove;
                                    } else {
                                        // 5. â˜…å³é‡ç›£è¦–â˜… æ–œã‚é€£ç¶šè„…å¨é˜»æ­¢
                                        console.log("ãƒ¬ãƒ™ãƒ«4: æ–œã‚è„…å¨é˜»æ­¢æ¤œç´¢ä¸­...");
                                        var diagonalThreat = findDiagonalThreat(game.aiPlayer);
                                        
                                        if (diagonalThreat) {
                                            console.log("ãƒ¬ãƒ™ãƒ«4: æ–œã‚è„…å¨é˜»æ­¢æ‰‹é¸æŠ");
                                            chosenMove = diagonalThreat;
                                        } else {
                                            // 6. â˜…äºˆé˜²ç­–â˜… 2-3æ‰‹å…ˆèª­ã¿ï¼ˆå°†æ¥è„…å¨äºˆé˜²ï¼‰
                                            console.log("ãƒ¬ãƒ™ãƒ«4: 2-3æ‰‹å…ˆèª­ã¿æ¤œç´¢ä¸­...");
                                            var futureThreat = findFutureThreats(game.aiPlayer);
                                            
                                            if (futureThreat) {
                                                console.log("ãƒ¬ãƒ™ãƒ«4: å°†æ¥è„…å¨äºˆé˜²æ‰‹é¸æŠ");
                                                chosenMove = futureThreat;
                                            } else {
                                                // 7. å›²ã¿é˜»æ­¢ï¼ˆè‡ªåˆ†ãŒå›²ã¾ã‚Œãã†ãªç·Šæ€¥å›é¿ï¼‰
                                                console.log("ãƒ¬ãƒ™ãƒ«4: å›²ã¿é˜»æ­¢æ¤œç´¢ä¸­...");
                                                var antiEncirclementMove = findAntiEncirclementMove(game.aiPlayer);
                                                
                                                if (antiEncirclementMove) {
                                                    console.log("ãƒ¬ãƒ™ãƒ«4: å›²ã¿é˜»æ­¢æ‰‹é¸æŠ");
                                                    chosenMove = antiEncirclementMove;
                                                } else {
                                                    // 8. è¤‡æ•°è„…å¨ä½œæˆï¼ˆæ”»æ’ƒé–‹å§‹ï¼‰
                                                    console.log("ãƒ¬ãƒ™ãƒ«4: è¤‡æ•°è„…å¨æ‰‹æ¤œç´¢ä¸­...");
                                                    var multipleThreatMove = findMultipleThreatMove(game.aiPlayer);
                                                    
                                                    if (multipleThreatMove) {
                                                        console.log("ãƒ¬ãƒ™ãƒ«4: è¤‡æ•°è„…å¨ä½œæˆæ‰‹é¸æŠ");
                                                        chosenMove = multipleThreatMove;
                                                    } else {
                                                        // 9. å›²ã¿æˆ¦ç•¥ï¼ˆç›¸æ‰‹ã‚’å›²ã‚€æ”»æ’ƒï¼‰
                                                        console.log("ãƒ¬ãƒ™ãƒ«4: å›²ã¿æˆ¦ç•¥æ¤œç´¢ä¸­...");
                                                        var encirclementMove = findEncirclementMove(game.aiPlayer);
                                                        
                                                        if (encirclementMove) {
                                                            console.log("ãƒ¬ãƒ™ãƒ«4: å›²ã¿æˆ¦ç•¥æ‰‹é¸æŠ");
                                                            chosenMove = encirclementMove;
                                                        } else {
                                                            // 10. ç›¸æ‰‹ã®è¤‡æ•°è„…å¨é˜»æ­¢
                                                            console.log("ãƒ¬ãƒ™ãƒ«4: ç›¸æ‰‹è¤‡æ•°è„…å¨é˜»æ­¢æ¤œç´¢ä¸­...");
                                                            var blockMultipleThreat = findMultipleThreatBlock(game.aiPlayer);
                                                            
                                                            if (blockMultipleThreat) {
                                                                console.log("ãƒ¬ãƒ™ãƒ«4: ç›¸æ‰‹è¤‡æ•°è„…å¨é˜»æ­¢");
                                                                chosenMove = blockMultipleThreat;
                                                            } else {
                                                                // 11. é«˜è„…å¨æ‰‹ï¼ˆ3é€£ä½œæˆãªã©ï¼‰
                                                                console.log("ãƒ¬ãƒ™ãƒ«4: é«˜è„…å¨æ‰‹æ¤œç´¢ä¸­...");
                                                                var highThreatMove = findHighThreatMove(game.aiPlayer);
                                                                
                                                                if (highThreatMove) {
                                                                    console.log("ãƒ¬ãƒ™ãƒ«4: é«˜è„…å¨æ‰‹é¸æŠ");
                                                                    chosenMove = highThreatMove;
                                                                } else {
                                                                    // 12. é›†ç´„æˆ¦ç•¥ï¼ˆè‡ªåˆ†ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’é›†ç´„ï¼‰
                                                                    console.log("ãƒ¬ãƒ™ãƒ«4: é›†ç´„æˆ¦ç•¥æ¤œç´¢ä¸­...");
                                                                    var clusterMove = findClusterMove(game.aiPlayer);
                                                                    
                                                                    if (clusterMove) {
                                                                        console.log("ãƒ¬ãƒ™ãƒ«4: é›†ç´„æˆ¦ç•¥æ‰‹é¸æŠ");
                                                                        chosenMove = clusterMove;
                                                                    } else {
                                                                        // 13. 2æ‰‹å‹åˆ©
                                                                        console.log("ãƒ¬ãƒ™ãƒ«4: 2æ‰‹å‹åˆ©æ¤œç´¢ä¸­...");
                                                                        var twoMoveWin = findTwoMoveWin(game.aiPlayer);
                                                                        
                                                                        if (twoMoveWin) {
                                                                            console.log("ãƒ¬ãƒ™ãƒ«4: 2æ‰‹å‹åˆ©æ‰‹é¸æŠ");
                                                                            chosenMove = twoMoveWin;
                                                                        } else {
                                                                            // 14. ç›¸æ‰‹ã®2æ‰‹å‹åˆ©é˜»æ­¢
                                                                            console.log("ãƒ¬ãƒ™ãƒ«4: ç›¸æ‰‹2æ‰‹å‹åˆ©é˜»æ­¢æ¤œç´¢ä¸­...");
                                                                            var opponent = game.aiPlayer === 1 ? 2 : 1;
                                                                            var opponentTwoMoveWin = findTwoMoveWin(opponent);
                                                                            
                                                                            if (opponentTwoMoveWin) {
                                                                                console.log("ãƒ¬ãƒ™ãƒ«4: ç›¸æ‰‹2æ‰‹å‹åˆ©é˜»æ­¢");
                                                                                chosenMove = opponentTwoMoveWin;
                                                                            } else {
                                                                                // 15. ç¸¦2é€£+æœ¬å‘½æ”»æ’ƒï¼ˆçµ‚ç›¤30å€‹ä»¥ä¸Šé™å®šï¼‰
                                                                                console.log("ãƒ¬ãƒ™ãƒ«4: ç¸¦2é€£+æœ¬å‘½æ”»æ’ƒæ¤œç´¢ä¸­...");
                                                                                var verticalComboMove = findVerticalDoublePlusThreatMove(game.aiPlayer);
                                                                                
                                                                                if (verticalComboMove) {
                                                                                    console.log("ãƒ¬ãƒ™ãƒ«4: ç¸¦2é€£+æœ¬å‘½æ”»æ’ƒé¸æŠ");
                                                                                    chosenMove = verticalComboMove;
                                                                                } else {
                                                                                    // 16. ç›¸æ‰‹ç¸¦2é€£é˜»æ­¢ï¼ˆçµ‚ç›¤30å€‹ä»¥ä¸Šé™å®šï¼‰
                                                                                    console.log("ãƒ¬ãƒ™ãƒ«4: ç›¸æ‰‹ç¸¦2é€£é˜»æ­¢æ¤œç´¢ä¸­...");
                                                                                    var verticalBlockMove = findVerticalDoubleBlock(game.aiPlayer);
                                                                                    
                                                                                    if (verticalBlockMove) {
                                                                                        console.log("ãƒ¬ãƒ™ãƒ«4: ç›¸æ‰‹ç¸¦2é€£é˜»æ­¢é¸æŠ");
                                                                                        chosenMove = verticalBlockMove;
                                                                                    } else {
                                                                                        // 17. ç¸¦2é€£ä½œæˆï¼ˆçµ‚ç›¤30å€‹ä»¥ä¸Šé™å®šï¼‰
                                                                                        console.log("ãƒ¬ãƒ™ãƒ«4: ç¸¦2é€£ä½œæˆæ¤œç´¢ä¸­...");
                                                                                        var verticalDoubleMove = findVerticalDoubleMove(game.aiPlayer);
                                                                                        
                                                                                        if (verticalDoubleMove) {
                                                                                            console.log("ãƒ¬ãƒ™ãƒ«4: ç¸¦2é€£ä½œæˆæ‰‹é¸æŠ");
                                                                                            chosenMove = verticalDoubleMove;
                                                                                        } else {
                                                                                            // 18. ä¸­å¤®åˆ¶åœ§
                                                                                            console.log("ãƒ¬ãƒ™ãƒ«4: ä¸­å¤®åˆ¶åœ§æ¤œç´¢ä¸­...");
                                                                                            var centerMove = findCenterMove();
                                                                                            
                                                                                            if (centerMove) {
                                                                                                console.log("ãƒ¬ãƒ™ãƒ«4: ä¸­å¤®åˆ¶åœ§æ‰‹é¸æŠ");
                                                                                                chosenMove = centerMove;
                                                                                            } else {
                                                                                                // 19. ãƒ©ãƒ³ãƒ€ãƒ 
                                                                                                console.log("ãƒ¬ãƒ™ãƒ«4: ãƒ©ãƒ³ãƒ€ãƒ æ‰‹é¸æŠ");
                                                                                                chosenMove = getRandomMove();
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error("ãƒ¬ãƒ™ãƒ«4AIå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:", error);
                        chosenMove = getRandomMove();
                        console.log("ãƒ¬ãƒ™ãƒ«4: ã‚¨ãƒ©ãƒ¼å¾Œã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯");
                    }
                    
                } else if (aiLevel === 5) {
                    // ãƒ¬ãƒ™ãƒ«5: ãƒŸãƒ‹ãƒãƒƒã‚¯ã‚¹æ³•ï¼ˆç ´å£Šçš„å¼·ã•ï¼‰
                    console.log("=== ãƒ¬ãƒ™ãƒ«5AIå‹•ä½œé–‹å§‹ï¼ˆãƒŸãƒ‹ãƒãƒƒã‚¯ã‚¹æ³•ï¼‰===");
                    
                    try {
                        // ãƒŸãƒ‹ãƒãƒƒã‚¯ã‚¹æ³•ã§æœ€é©æ‰‹ã‚’è¨ˆç®—
                        chosenMove = findMinimaxMove(game.aiPlayer);
                        console.log("ãƒ¬ãƒ™ãƒ«5: ãƒŸãƒ‹ãƒãƒƒã‚¯ã‚¹æœ€é©æ‰‹é¸æŠ", chosenMove);
                        
                    } catch (error) {
                        console.error("ãƒ¬ãƒ™ãƒ«5AIå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:", error);
                        chosenMove = getRandomMove();
                        console.log("ãƒ¬ãƒ™ãƒ«5: ã‚¨ãƒ©ãƒ¼å¾Œã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯");
                    }
                    
                } else if (aiLevel === 6) {
                    // ãƒ¬ãƒ™ãƒ«6: ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆå­¦ç¿’å‹AIï¼‰
                    console.log("=== ãƒ¬ãƒ™ãƒ«6AIå‹•ä½œé–‹å§‹ï¼ˆãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ï¼‰===");
                    
                    try {
                        // ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯
                        if (!deepLearningAI.model) {
                            console.log("ğŸ§  åˆå›èµ·å‹• - ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–ä¸­...");
                            await deepLearningAI.initModel();
                        }
                        
                        // å­¦ç¿’å‹AIã§æœ€é©æ‰‹ã‚’äºˆæ¸¬
                        chosenMove = await deepLearningAI.predictBestMove();
                        console.log("ãƒ¬ãƒ™ãƒ«6: ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°æœ€é©æ‰‹é¸æŠ", chosenMove);
                        
                        // å¯¾æˆ¦ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²
                        if (chosenMove) {
                            var boardState = deepLearningAI.boardToArray();
                            deepLearningAI.recordGameMove(boardState, chosenMove, 0);
                        }
                        
                    } catch (error) {
                        console.error("ãƒ¬ãƒ™ãƒ«6AIå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:", error);
                        chosenMove = getRandomMove();
                        console.log("ãƒ¬ãƒ™ãƒ«6: ã‚¨ãƒ©ãƒ¼å¾Œã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯");
                    }
                    
                } else {
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ãƒ©ãƒ³ãƒ€ãƒ 
                    chosenMove = getRandomMove();
                    console.log("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰æˆ¦ç•¥ã§æ‰‹ã‚’é¸æŠ");
                }

                console.log('AIé¸æŠã—ãŸæ‰‹:', chosenMove);

                if (chosenMove) {
                    console.log(`AIé…ç½®å®Ÿè¡Œ: (${chosenMove[0]}, ${chosenMove[1]})`);
                    placePiece(chosenMove[0], chosenMove[1], true);
                    placed++;
                    setTimeout(placeOneBlock, 600);
                } else {
                    console.warn("AIãŒæœ‰åŠ¹ãªæ‰‹ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸ");
                    game.aiThinking = false;
                }
            }

            placeOneBlock();
        }

        // å‹åˆ©ãƒã‚§ãƒƒã‚¯
        function checkWin(row, col) {
            var player = game.grid[row][col];
            var directions = [
                [0, 1],  // æ¨ª
                [1, 0],  // ç¸¦
                [1, 1],  // æ–œã‚å³ä¸‹
                [1, -1]  // æ–œã‚å·¦ä¸‹
            ];

            for (var d = 0; d < directions.length; d++) {
                var dr = directions[d][0];
                var dc = directions[d][1];
                var line = [[row, col]];
                
                // å·¦å´ãƒã‚§ãƒƒã‚¯
                for (var i = 1; i < WIN_COUNT; i++) {
                    var r = row - dr * i;
                    var c = col - dc * i;
                    if (r >= 0 && r < GRID_HEIGHT && c >= 0 && c < GRID_WIDTH && 
                        game.grid[r][c] === player) {
                        line.unshift([r, c]);
                    } else {
                        break;
                    }
                }
                
                // å³å´ãƒã‚§ãƒƒã‚¯
                for (var i = 1; i < WIN_COUNT; i++) {
                    var r = row + dr * i;
                    var c = col + dc * i;
                    if (r >= 0 && r < GRID_HEIGHT && c >= 0 && c < GRID_WIDTH && 
                        game.grid[r][c] === player) {
                        line.push([r, c]);
                    } else {
                        break;
                    }
                }
                
                if (line.length >= WIN_COUNT) {
                    game.winningCells = line;
                    return true;
                }
            }
            
            return false;
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        function showAlert(message) {
            var existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            var alert = document.createElement('div');
            alert.className = 'alert';
            alert.textContent = message;
            document.body.appendChild(alert);
            
            setTimeout(function() {
                alert.remove();
            }, 2000);
        }

        // â˜…ä¿®æ­£ç‰ˆâ˜… ã‚²ãƒ¼ãƒ çµ‚äº†
        function endGame(winner) {
            console.log(`ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†é–‹å§‹ - å‹è€…: ${winner}`);
            
            game.gameActive = false;
            clearInterval(game.timer);
            
            clearWinningCells(); // å‹åˆ©ãƒ©ã‚¤ãƒ³ã‚’ã‚¯ãƒªã‚¢
            game.aiThinking = false; // AIæ€è€ƒãƒ•ãƒ©ã‚°ã‚‚ã‚¯ãƒªã‚¢

            // â˜…LEVEL6 å­¦ç¿’å‡¦ç†â˜…
            if (game.isAI && aiLevel === 6 && deepLearningAI.model) {
                console.log("ğŸ§  ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°AIå­¦ç¿’é–‹å§‹...");
                deepLearningAI.learnFromGame(winner).then(function() {
                    console.log("ğŸ“š å­¦ç¿’å®Œäº† - AIãŒçµŒé¨“ã‚’ç©ã¿ã¾ã—ãŸ");
                }).catch(function(error) {
                    console.error("âŒ å­¦ç¿’ã‚¨ãƒ©ãƒ¼:", error);
                });
            }

            var modal = document.getElementById('gameModal');
            var message = document.getElementById('modalMessage');
            var title = document.getElementById('modalTitle');
            var icon = document.getElementById('winnerIcon');

            if (winner === 1) {
                if (game.isAI && game.aiPlayer === 1) {
                    if (aiLevel === 6) {
                        title.textContent = 'ğŸ§  å­¦ç¿’AI ã®å‹åˆ©ï¼';
                        message.textContent = 'AIãŒã‚ãªãŸã®æˆ¦è¡“ã‚’å­¦ç¿’ã—ã¦å‹åˆ©ã—ã¾ã—ãŸã€‚å†æˆ¦ã§ã•ã‚‰ã«å­¦ç¿’ã—ã¾ã™ï¼';
                    } else {
                        title.textContent = 'ğŸ¤– AIã®å‹åˆ©ï¼';
                        message.textContent = 'ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚å†æˆ¦ã—ã¾ã™ã‹ï¼Ÿ';
                    }
                } else {
                    title.textContent = 'ğŸ‰ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®å‹åˆ©ï¼';
                    message.textContent = 'ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚å†æˆ¦ã—ã¾ã™ã‹ï¼Ÿ';
                }
                icon.style.background = '#ef4444';
            } else if (winner === 2) {
                if (game.isAI && game.aiPlayer === 2) {
                    if (aiLevel === 6) {
                        title.textContent = 'ğŸ§  å­¦ç¿’AI ã®å‹åˆ©ï¼';
                        message.textContent = 'AIãŒã‚ãªãŸã®æˆ¦è¡“ã‚’å­¦ç¿’ã—ã¦å‹åˆ©ã—ã¾ã—ãŸã€‚å†æˆ¦ã§ã•ã‚‰ã«å­¦ç¿’ã—ã¾ã™ï¼';
                    } else {
                        title.textContent = 'ğŸ¤– AIã®å‹åˆ©ï¼';
                        message.textContent = 'ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚å†æˆ¦ã—ã¾ã™ã‹ï¼Ÿ';
                    }
                } else {
                    title.textContent = 'ğŸ‰ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®å‹åˆ©ï¼';
                    message.textContent = 'ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚å†æˆ¦ã—ã¾ã™ã‹ï¼Ÿ';
                }
                icon.style.background = '#3b82f6';
            } else {
                title.textContent = 'ğŸ¤ ã‚²ãƒ¼ãƒ çµ‚äº†';
                icon.style.background = '#9ca3af';
                message.textContent = 'ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚å†æˆ¦ã—ã¾ã™ã‹ï¼Ÿ';
            }

            modal.style.display = 'block';
            
            console.log("ã‚²ãƒ¼ãƒ çµ‚äº†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå®Œäº†");
        }

        function endGameNow() {
            endGame(0);
        }

    </script>
</body>
</html>
