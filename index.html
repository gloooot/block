<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‰ãƒ­ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ–</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .start-screen {
            text-align: center;
            padding: 40px;
        }

        .game-title {
            font-size: 3em;
            color: #333;
            margin-bottom: 20px;
        }

        .rules {
            text-align: left;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .rules ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .rules li {
            margin: 8px 0;
        }

        .btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn.ai-mode {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .game-screen {
            display: none;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .game-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .players {
            display: flex;
            gap: 30px;
        }

        .player {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
        }

        .player.active {
            font-weight: bold;
        }

        .player.ai {
            font-style: italic;
        }

        .player-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .red { background: #ef4444; }
        .blue { background: #3b82f6; }

        .timer {
            font-size: 24px;
            font-weight: bold;
        }

        .timer.warning {
            color: #ef4444;
            animation: blink 1s infinite;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }

        .grid-container {
            text-align: center;
            padding: 20px;
            overflow-x: auto;
        }

        .grid {
            display: inline-grid;
            grid-template-columns: repeat(15, 32px);
            gap: 2px;
            background: #ddd;
            padding: 10px;
            border-radius: 8px;
            min-width: max-content;
        }

        .cell {
            width: 32px;
            height: 32px;
            background: white;
            border: 3px solid transparent;
            box-sizing: border-box;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .cell:hover {
            background: #f0f0f0;
            border-color: #ddd;
        }

        .cell.ground {
            background: #fef3c7;
            border-bottom-color: #d97706;
        }

        .cell.red {
            background: #ef4444;
            color: white;
            border-color: #dc2626;
        }

        .cell.blue {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
        }

        .cell.winning {
            border-color: #fbbf24;
            animation: winningBlink 1s infinite;
            box-shadow: 0 0 10px #fbbf24;
        }

        .cell.dropping {
            animation: drop 0.5s ease-out;
        }

        .ground-label {
            margin-top: 15px;
            color: #d97706;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .winner-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 20px;
        }

        .alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ef4444;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 1001;
            animation: alertShow 0.3s ease-out;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }

        @keyframes winningBlink {
            0%, 100% { 
                border-color: #fbbf24;
                box-shadow: 0 0 10px #fbbf24;
            }
            50% { 
                border-color: #f59e0b;
                box-shadow: 0 0 20px #f59e0b;
            }
        }

        @keyframes drop {
            0% { transform: translateY(-20px); opacity: 0.7; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes turnFlash {
            0% { transform: scale(1); opacity: 1; }
            30% { transform: scale(1.3); opacity: 0.8; }
            60% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        .player.flash {
            animation: turnFlash 0.8s ease-out;
            color: #fbbf24;
        }

        @media (max-width: 600px) {
            .grid {
                grid-template-columns: repeat(15, 20px);
            }
            .cell {
                width: 20px;
                height: 20px;
                font-size: 12px;
            }
            .game-status {
                flex-direction: column;
                gap: 15px;
            }
            .players {
                gap: 20px;
            }
        }
        .grid.turn-red {
          border: 3px solid #ef4444;
          animation: flash-red 1s;
        }
        .grid.turn-blue {
          border: 3px solid #3b82f6;
          animation: flash-blue 1s;
        }

        @keyframes flash-red {
              0% { box-shadow: 0 0 0px #ef4444; }
              50% { box-shadow: 0 0 20px #ef4444; }
              100% { box-shadow: 0 0 0px #ef4444; }
        }
        
        @keyframes flash-blue {
              0% { box-shadow: 0 0 0px #3b82f6; }
              50% { box-shadow: 0 0 20px #3b82f6; }
              100% { box-shadow: 0 0 0px #3b82f6; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
        <div id="startScreen" class="card start-screen">
            <h1 class="game-title">ãƒ‰ãƒ­ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ–</h1>
            <p>2äººå¯¾æˆ¦ãƒ–ãƒ­ãƒƒã‚¯é…ç½®ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ </p>
            
            <div class="rules">
                <h3>ğŸ“‹ ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«</h3>
                <ul>
                    <li>å…ˆè¡Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è‰²ã®ãƒ–ãƒ­ãƒƒã‚¯ãŒä¸­å¤®ã«1å€‹é…ç½®ã•ã‚Œã¾ã™</li>
                    <li>å…ˆè¡Œã¯åˆæ‰‹ã§1å€‹ã®ã¿é…ç½®å¯èƒ½</li>
                    <li>2ã‚¿ãƒ¼ãƒ³ç›®ä»¥é™ã¯å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ1ã‚¿ãƒ¼ãƒ³ã«2å€‹é…ç½®</li>
                    <li>ç¸¦ãƒ»æ¨ªãƒ»æ–œã‚ã®ã„ãšã‚Œã‹ã§5å€‹é€£ç¶šã«ä¸¦ã¹ã‚‹ã¨å‹åˆ©</li>
                    <li>1éšï¼ˆåœ°é¢ï¼‰ã§ã¯éš£æ¥ã™ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ãŒå¿…è¦</li>
                    <li>2éšä»¥ä¸Šã§ã¯éš£æ¥åˆ¶é™ãªã—</li>
                    <li>ãƒ–ãƒ­ãƒƒã‚¯ã¯é‡åŠ›ã§è‡ªå‹•çš„ã«è½ä¸‹</li>
                    <li>åˆ¶é™æ™‚é–“å†…ã«é…ç½®ã—ãªã„ã¨è² ã‘</li>
                </ul>
            </div>

            <div style="margin: 20px 0;">
                <label style="font-weight: bold; color: #333;">ğŸ¤– AIã®å¼·ã•ã‚’é¸ã¶ï¼š</label><br>
                <select id="aiLevelSelect" style="padding: 8px 16px; font-size: 16px; border-radius: 6px;">
                    <option value="1">Lv1ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰</option>
                    <option value="2">Lv2ï¼ˆæ”»æ’ƒå‹ï¼‰</option>
                    <option value="3">Lv3ï¼ˆæ”»é˜²å‹ï¼‰</option>
                    <option value="4">Lv4ï¼ˆé«˜åº¦AIï¼‰</option>
                </select>
            </div>
            
            <button class="btn" onclick="startGame(false)">ğŸ‘¥ 2äººå¯¾æˆ¦</button>
            <button class="btn ai-mode" onclick="startGame(true)">ğŸ¤– AIã¨å¯¾æˆ¦</button>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="gameScreen" class="game-screen">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="card">
                <div class="game-header">
                    <h2>ãƒ‰ãƒ­ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ–</h2>
                    <div>
                        <button class="btn" onclick="showStart()">æ–°ã—ã„ã‚²ãƒ¼ãƒ </button>
                        <button class="btn" onclick="endGameNow()" style="background: #dc2626; margin-left: 10px;">ã‚²ãƒ¼ãƒ çµ‚äº†</button>
                    </div>
                </div>
            </div>

            <!-- ã‚²ãƒ¼ãƒ çŠ¶æ³ -->
            <div class="card">
                <div class="game-status">
                    <div class="players">
                        <div class="player" id="player1">
                            <div class="player-color red"></div>
                            <span>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</span>
                        </div>
                        <div class="player" id="player2">
                            <div class="player-color blue"></div>
                            <span>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2</span>
                        </div>
                    </div>
                    <div class="timer" id="timer">5:00</div>
                </div>
                <div class="game-info">
                    <div>ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³: <span id="currentPlayer">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</span></div>
                    <div>æ®‹ã‚Šãƒ–ãƒ­ãƒƒã‚¯: <span id="remainingBlocks">1</span>/<span id="maxBlocks">1</span></div>
                </div>
            </div>

            <!-- ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ -->
            <div class="card grid-container">
                <div class="grid" id="gameGrid"></div>
                <div class="ground-label">â¬†ï¸ åœ°é¢ãƒ¬ãƒ™ãƒ«ï¼ˆéš£æ¥ãƒ–ãƒ­ãƒƒã‚¯å¿…è¦ï¼‰</div>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ çµ‚äº†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="gameModal" class="modal">
            <div class="modal-content">
                <h2 id="modalTitle">ã‚²ãƒ¼ãƒ çµ‚äº†</h2>
                <div class="winner-icon" id="winnerIcon"></div>
                <p id="modalMessage">çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
                <button class="btn" onclick="startGame(false)">2äººå¯¾æˆ¦</button>
                <button class="btn ai-mode" onclick="startGame(true)">AIã¨å¯¾æˆ¦</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ è¨­å®š
        var GRID_WIDTH = 15;
        var GRID_HEIGHT = 12;
        var WIN_COUNT = 5;
        var BLOCKS_PER_TURN = 2;
        var INITIAL_TIME = 300; // 5åˆ†
        var aiLevel = 1; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯Lv1ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        var game = {
            grid: [],
            currentPlayer: 1,
            remainingBlocks: 1, // å…ˆè¡Œã¯åˆæ‰‹1å€‹ã®ã¿
            timeLeft: 30, // åˆæ‰‹ã¯30ç§’
            gameActive: false,
            timer: null,
            animating: false,
            winningCells: [],
            showingWin: false,
            turnCount: 0, // åˆæ‰‹ã‹ã©ã†ã‹ã®åˆ¤å®šç”¨
            isAI: false // AIãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹
        };

        // ã‚°ãƒªãƒƒãƒ‰åˆæœŸåŒ–
        function initGrid() {
            game.grid = [];
            for (var row = 0; row < GRID_HEIGHT; row++) {
                game.grid[row] = [];
                for (var col = 0; col < GRID_WIDTH; col++) {
                    game.grid[row][col] = 0;
                }
            }
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame(isVsAI) {
             resetFieldVisuals();
          if (typeof isVsAI === 'undefined') {
                isVsAI = false   
          }
                
            // AIãƒ¬ãƒ™ãƒ«ã‚’å–å¾—
            var levelSelect = document.getElementById('aiLevelSelect');
            aiLevel = levelSelect ? parseInt(levelSelect.value) : 1;
                    
            
            initGrid();
            game.currentPlayer = Math.random() > 0.5 ? 1 : 2;
            game.remainingBlocks = 1; // å…ˆè¡Œã¯åˆæ‰‹1å€‹ã®ã¿
            game.turnCount = 0; // åˆæ‰‹ã‚«ã‚¦ãƒ³ãƒˆ
            game.gameActive = true;
            game.animating = false;
            game.winningCells = [];
            game.showingWin = false;
            game.isAI = isVsAI; // AIãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š

            // å…ˆè¡Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è‰²ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’çœŸã‚“ä¸­ã®åœ°é¢ã«è¨­ç½®
            var centerCol = Math.floor(GRID_WIDTH / 2);
            var groundRow = GRID_HEIGHT - 1;
            game.grid[groundRow][centerCol] = game.currentPlayer;

            setTurnTimer(); // ã‚¿ã‚¤ãƒãƒ¼ã‚’æœ€åˆã«è¨­å®š
            startTimer();

            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            document.getElementById('gameModal').style.display = 'none';

            createGrid();
            updateDisplay();
            if (game.isAI && game.currentPlayer === 2) {
                setTimeout(cpuPlay, 1500); // åˆæ‰‹ãŒAIã ã£ãŸã¨ã
            }

        }

        // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢è¡¨ç¤º
        function showStart() {
            clearInterval(game.timer);
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('gameModal').style.display = 'none';
        }

        // ã‚°ãƒªãƒƒãƒ‰ä½œæˆ
        function createGrid() {
            var gridElement = document.getElementById('gameGrid');
            gridElement.innerHTML = '';
        
            // â­ ã“ã“ã‚’è¿½åŠ ï¼ˆåˆ—æ•°ã«å¿œã˜ã¦æ¨ªå¹…ã‚’å†è¨­å®šï¼ï¼‰
            gridElement.style.gridTemplateColumns = `repeat(${GRID_WIDTH}, 32px)`;
        
            for (var row = 0; row < GRID_HEIGHT; row++) {
                for (var col = 0; col < GRID_WIDTH; col++) {
                    var cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.onclick = function() {
                        var clickedRow = parseInt(this.dataset.row);
                        var clickedCol = parseInt(this.dataset.col);
                        placePiece(clickedRow, clickedCol);
                    };
        
                    if (row === GRID_HEIGHT - 1) {
                        cell.classList.add('ground');
                    }
        
                    gridElement.appendChild(cell);
                }
            }
        }


        // è¡¨ç¤ºæ›´æ–°
        function updateDisplay() {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤º
            document.getElementById('player1').classList.toggle('active', game.currentPlayer === 1);
            document.getElementById('player2').classList.toggle('active', game.currentPlayer === 2);
            
            // AIãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã‚’AIã¨ã—ã¦è¡¨ç¤º
            var player2Element = document.getElementById('player2');
            if (game.isAI) {
                player2Element.classList.add('ai');
                player2Element.querySelector('span').textContent = 'AI';
            } else {
                player2Element.classList.remove('ai');
                player2Element.querySelector('span').textContent = 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';
            }
            
            // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
            var currentPlayerName = game.currentPlayer === 1 ? 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1' : (game.isAI ? 'AI' : 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2');
            document.getElementById('currentPlayer').textContent = currentPlayerName;
            
            // æ®‹ã‚Šãƒ–ãƒ­ãƒƒã‚¯è¡¨ç¤º
            document.getElementById('remainingBlocks').textContent = game.remainingBlocks;
            var currentBlocks = countCurrentBlocks();
            var maxBlocks = currentBlocks === 1 ? 1 : BLOCKS_PER_TURN; // å…ˆè¡Œåˆæ‰‹ã¯1å€‹ã€ãã‚Œä»¥å¤–ã¯2å€‹
            document.getElementById('maxBlocks').textContent = maxBlocks;
            
            // ã‚¿ã‚¤ãƒãƒ¼
            var minutes = Math.floor(game.timeLeft / 60);
            var seconds = game.timeLeft % 60;
            var timerElement = document.getElementById('timer');
            timerElement.textContent = minutes + ':' + seconds.toString().padStart(2, '0');
            timerElement.classList.toggle('warning', game.timeLeft <= 30);

            // ã‚°ãƒªãƒƒãƒ‰æ›´æ–°
            updateGrid();
        }
        ///ã‚¿ãƒ¼ãƒ³äº¤ä»£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function applyTurnEffect() {
            const grid = document.getElementById('gameGrid');
            grid.classList.remove('turn-red', 'turn-blue'); // å‰ã®ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        
            if (game.currentPlayer === 1) {
                grid.classList.add('turn-red');
            } else if (game.currentPlayer === 2) {
                grid.classList.add('turn-blue');
            }
        
            // 1ç§’å¾Œã«ã‚¯ãƒ©ã‚¹å‰Šé™¤ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†ï¼‰
            setTimeout(() => {
                grid.classList.remove('turn-red', 'turn-blue');
            }, 1000);
        }


        // ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºæ›´æ–°
        function updateGrid() {
            var cells = document.querySelectorAll('.cell');
            var index = 0;
            
            for (var row = 0; row < GRID_HEIGHT; row++) {
                for (var col = 0; col < GRID_WIDTH; col++) {
                    var cell = cells[index];
                    var value = game.grid[row][col];
                    
                    cell.className = 'cell';
                    if (row === GRID_HEIGHT - 1) {
                        cell.classList.add('ground');
                    }
                    
                    if (value === 1) {
                        cell.classList.add('red');
                        cell.textContent = 'â—';
                    } else if (value === 2) {
                        cell.classList.add('blue');
                        cell.textContent = 'â—';
                    } else {
                        cell.textContent = '';
                    }
                    
                    index++;
                }
            }
            
            // å‹åˆ©ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç‚¹æ»…è¡¨ç¤º
            if (game.winningCells.length > 0) {
                for (var w = 0; w < game.winningCells.length; w++) {
                    var r = game.winningCells[w][0];
                    var c = game.winningCells[w][1];
                    var idx = r * GRID_WIDTH + c;
                    if (cells[idx]) {
                        cells[idx].classList.add('winning');
                    }
                }
            }
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        function showAlert(message) {
            var existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            var alert = document.createElement('div');
            alert.className = 'alert';
            alert.textContent = message;
            document.body.appendChild(alert);
            
            setTimeout(function() {
                alert.remove();
            }, 2000);
        }

        // ç¾åœ¨ã®ãƒ–ãƒ­ãƒƒã‚¯æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        function countCurrentBlocks() {
            var count = 0;
            for (var row = 0; row < GRID_HEIGHT; row++) {
                for (var col = 0; col < GRID_WIDTH; col++) {
                    if (game.grid[row][col] !== 0) {
                        count++;
                    }
                }
            }
            return count;
        }
        function resetFieldVisuals() {
            const grid = document.getElementById('gameGrid');
            grid.classList.remove('turn-red', 'turn-blue');
            grid.style.border = 'none';
            grid.style.boxShadow = 'none';
        }


        // ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã®ã‚¿ã‚¤ãƒãƒ¼è¨­å®š
        function setTurnTimer() {
            var currentBlocks = countCurrentBlocks();
            
            if (game.turnCount === 0) {
                // å…ˆè¡Œåˆæ‰‹
                game.timeLeft = 15;
            } else if (game.turnCount === 1 && currentBlocks === 2) {
                // å¾Œæ”»åˆæ‰‹ï¼ˆãƒ–ãƒ­ãƒƒã‚¯æ•°2å€‹ï¼šä¸­å¤®ï¼‹å…ˆè¡Œ1å€‹ï¼‰
                game.timeLeft = 30;
            } else {
                // 2ã‚¿ãƒ¼ãƒ³ç›®ä»¥é™
                game.timeLeft = currentBlocks * 10;
            }
        }
      
      function startTimer() {
          clearInterval(game.timer);
          game.timer = setInterval(function() {
            game.timeLeft--;
            updateDisplay();
            if (game.timeLeft <= 0) {
              clearInterval(game.timer);
              endGame(game.currentPlayer === 1 ? 2 : 1); // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§è² ã‘
            }
          }, 1000);
      }
        

    //ãƒã‚¹æ‹¡å¤§
        function extendGrid(direction) {
            if (direction === 'right') {
                for (let row = 0; row < GRID_HEIGHT; row++) {
                    game.grid[row].push(0);
                }
                GRID_WIDTH++;
            } else if (direction === 'left') {
                for (let row = 0; row < GRID_HEIGHT; row++) {
                    game.grid[row].unshift(0);
                }
                GRID_WIDTH++;
            } else if (direction === 'top') {
                const newRow = new Array(GRID_WIDTH).fill(0);
                game.grid.unshift(newRow);
                GRID_HEIGHT++;
            }
        
            createGrid();
            updateGridTemplate(); // â† å¿…é ˆï¼
            updateDisplay();
        }


        function checkAndExtendGrid() {
            for (let row = 0; row < GRID_HEIGHT; row++) {
                if (game.grid[row][0] !== 0) {
                    extendGrid('left');
                    break;
                }
            }
        
            for (let row = 0; row < GRID_HEIGHT; row++) {
                if (game.grid[row][GRID_WIDTH - 1] !== 0) {
                    extendGrid('right');
                    break;
                }
            }
        
            for (let col = 0; col < GRID_WIDTH; col++) {
                if (game.grid[0][col] !== 0) {
                    extendGrid('top');
                    break;
                }
            }
        }

        function updateGridTemplate() {
            const grid = document.getElementById('gameGrid');
            grid.style.gridTemplateColumns = `repeat(${GRID_WIDTH}, 32px)`;
        }

        

        // ãƒ”ãƒ¼ã‚¹é…ç½®ï¼ˆæ–°ä»•æ§˜ï¼šã‚¯ãƒªãƒƒã‚¯ã—ãŸä½ç½®ã«é…ç½®ã‚’è©¦ã¿ã‚‹ï¼‰
       f// ===== ã‚¹ãƒ†ãƒƒãƒ—4: å…ƒã®placePieceé–¢æ•°ã®æœ€åˆã«è¿½åŠ ã—ã¦ãã ã•ã„ =====

        function placePiece(row, col) {
            // ã‚¨ãƒ©ãƒ¼å¯¾ç­–: try-catchã§ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
            try {
                // === å…ƒã®å‡¦ç†ã®å‰ã«å¢ƒç•Œãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ  ===
                
                // 1. ä½ç½®ãŒç¯„å›²å†…ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (row < 0 || row >= GRID_HEIGHT || col < 0 || col >= GRID_WIDTH) {
                    console.warn(`ç„¡åŠ¹ãªä½ç½®ã§ã™: (${row}, ${col})`);
                    return;
                }
                
                // 2. ã‚²ãƒ¼ãƒ ãŒé€²è¡Œä¸­ã‹ãƒã‚§ãƒƒã‚¯
                if (!game.gameActive || game.animating || game.remainingBlocks <= 0) {
                    return;
                }
                
                // 3. AIã®ã‚¿ãƒ¼ãƒ³ä¸­ã«äººé–“ãŒã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯ç„¡è¦–
                if (game.isAI && game.currentPlayer === 2) {
                    return;
                }
                
                // === ã“ã“ã‹ã‚‰å…ƒã®placePieceé–¢æ•°ã®å‡¦ç†ã‚’ç¶šã‘ã‚‹ ===
                
                // ãƒã‚¹ãŒæ—¢ã«åŸ‹ã¾ã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (game.grid[row][col] !== 0) {
                    if (!game.isAI || game.currentPlayer !== 2) {
                        showAlert("ãã®ãƒã‚¹ã«ã¯æ—¢ã«ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚Šã¾ã™ï¼");
                    }
                    return;
                }
                
                // ä¸‹ã«æ”¯ãˆãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆåœ°é¢ä»¥å¤–ã®å ´åˆï¼‰
                if (row < GRID_HEIGHT - 1 && game.grid[row + 1][col] === 0) {
                    if (!game.isAI || game.currentPlayer !== 2) {
                        showAlert("ã“ã®ä½ç½®ã«ã¯ä¸‹ã«æ”¯ãˆãŒã‚ã‚Šã¾ã›ã‚“ï¼");
                    }
                    return;
                }
                
                // åœ°é¢ã®å ´åˆã¯éš£æ¥ãƒ–ãƒ­ãƒƒã‚¯ãŒå¿…è¦
                if (row === GRID_HEIGHT - 1 && !isValidGroundPlacement(col)) {
                    if (!game.isAI || game.currentPlayer !== 2) {
                        showAlert("åœ°é¢ã«ç½®ãã«ã¯éš£æ¥ãƒ–ãƒ­ãƒƒã‚¯ãŒå¿…è¦ã§ã™ï¼");
                    }
                    return;
                }
                
                // === ã“ã“ã‹ã‚‰å®Ÿéš›ã«ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç½®ãå‡¦ç† ===
                
                game.animating = true; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ãƒ•ãƒ©ã‚°ã‚’ON
                
                // å¯¾è±¡ã®ãƒã‚¹ã‚’å–å¾—
                var cells = document.querySelectorAll('.cell');
                var cellIndex = row * GRID_WIDTH + col;
                var targetCell = cells[cellIndex];
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœã‚’è¿½åŠ 
                if (targetCell) {
                    targetCell.classList.add('dropping');
                }
                
                // 0.3ç§’å¾Œã«ãƒ–ãƒ­ãƒƒã‚¯ã‚’å®Ÿéš›ã«é…ç½®
                setTimeout(function () {
                    game.grid[row][col] = game.currentPlayer; // ã‚°ãƒªãƒƒãƒ‰ã«ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¨˜éŒ²
                    game.remainingBlocks--; // æ®‹ã‚Šãƒ–ãƒ­ãƒƒã‚¯æ•°ã‚’æ¸›ã‚‰ã™
                    
                    // å‹åˆ©åˆ¤å®š
                    if (checkWin(row, col)) {
                        game.showingWin = true;
                        showWinAnimation(function () {
                            endGame(game.currentPlayer);
                        });
                        return;
                    }
                    
                    // ã“ã®ã‚¿ãƒ¼ãƒ³ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’å…¨ã¦ç½®ãçµ‚ã‚ã£ãŸå ´åˆ
                    if (game.remainingBlocks <= 0) {
                        setTimeout(function () {
                            clearInterval(game.timer); // ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
                            
                            // ã‚¿ãƒ¼ãƒ³ã‚’äº¤ä»£
                            game.currentPlayer = game.currentPlayer === 1 ? 2 : 1;
                            game.remainingBlocks = BLOCKS_PER_TURN;
                            game.turnCount++;
                            
                            // æ–°ã—ã„ã‚¿ãƒ¼ãƒ³ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
                            setTurnTimer();
                            startTimer();
                            applyTurnEffect();
                            updateDisplay();
                            
                            // AIã®ã‚¿ãƒ¼ãƒ³ã«ãªã£ãŸå ´åˆ
                            if (game.isAI && game.currentPlayer === 2) {
                                setTimeout(cpuPlay, 800);
                            }
                        }, 500);
                    }
                    
                    game.animating = false; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†
                    updateDisplay(); // ç”»é¢ã‚’æ›´æ–°
                    checkAndExtendGrid(); // å¿…è¦ã«å¿œã˜ã¦ã‚°ãƒªãƒƒãƒ‰ã‚’æ‹¡å¼µ
                    
                }, 300);
                
            } catch (error) {
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®å‡¦ç†
                console.error("ãƒ–ãƒ­ãƒƒã‚¯é…ç½®ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                game.animating = false; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                showAlert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
            }
        }


////////////////////////AIé–¢é€£
        
            // 1. ãƒ©ãƒ³ãƒ€ãƒ ãªæ‰‹ã‚’é¸ã¶é–¢æ•°
            function getRandomMove() {
                // å…¨ã¦ã®æœ‰åŠ¹ãªä½ç½®ã‚’å–å¾—
                const validMoves = getAllValidMoves();
                
                // æœ‰åŠ¹ãªä½ç½®ãŒãªã„å ´åˆã¯nullã‚’è¿”ã™
                if (validMoves.length === 0) return null;
                
                // ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸ã¶
                const randomIndex = Math.floor(Math.random() * validMoves.length);
                return validMoves[randomIndex];
            }
            
            // 2. getRandomValidMoveã¨ã„ã†åå‰ã§ã‚‚åŒã˜æ©Ÿèƒ½ã‚’æä¾›
            function getRandomValidMove() {
                return getRandomMove(); // ä¸Šã®é–¢æ•°ã¨åŒã˜
            }
            
            // 3. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¨ã£ã¦æœ€è‰¯ã®æ‰‹ã‚’æ¢ã™é–¢æ•°
            function findBestMoveForPlayer(player) {
                // ã¾ãšå‹ã¦ã‚‹æ‰‹ãŒã‚ã‚‹ã‹ç¢ºèª
                const winMove = findWinningMove(player);
                if (winMove) return winMove; // å‹ã¦ã‚‹ãªã‚‰ãã®æ‰‹ã‚’è¿”ã™
                
                // å‹ã¦ãªã„å ´åˆã€ç›¸æ‰‹ã®å‹åˆ©ã‚’é˜²ãæ‰‹ãŒã‚ã‚‹ã‹ç¢ºèª
                const opponent = player === 1 ? 2 : 1; // ç›¸æ‰‹ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç•ªå·
                const blockMove = findWinningMove(opponent);
                if (blockMove) return blockMove; // ç›¸æ‰‹ã®å‹åˆ©ã‚’é˜²ã’ã‚‹ãªã‚‰ãã®æ‰‹ã‚’è¿”ã™
                
                // ã©ã¡ã‚‰ã§ã‚‚ãªã„å ´åˆã¯nullã‚’è¿”ã™
                return null;
            }
        
        // AIï¼ˆCPUï¼‰ã®ãƒ—ãƒ¬ã‚¤é–¢æ•°
           function cpuPlay() {
            // ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ã¦ã„ãŸã‚Šã€AIã®ã‚¿ãƒ¼ãƒ³ã§ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (!game.gameActive || game.currentPlayer !== 2 || !game.isAI || game.showingWin) {
                return;
            }
            
            // ãƒ–ãƒ­ãƒƒã‚¯ãŒæ®‹ã£ã¦ã„ãªã„å ´åˆã¯ã€æ–°ã—ã„ã‚¿ãƒ¼ãƒ³ç”¨ã«ãƒ–ãƒ­ãƒƒã‚¯æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (game.remainingBlocks <= 0) {
                game.remainingBlocks = BLOCKS_PER_TURN;
            }
            
            let placed = 0; // ä»Šã®ã‚¿ãƒ¼ãƒ³ã§ç½®ã„ãŸãƒ–ãƒ­ãƒƒã‚¯æ•°
            const maxBlocks = game.remainingBlocks; // ã“ã®ã‚¿ãƒ¼ãƒ³ã§ç½®ã‘ã‚‹ãƒ–ãƒ­ãƒƒã‚¯æ•°
            
            // 1ã¤ãšã¤ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç½®ãé–¢æ•°
            function placeOneBlock() {
                // å…¨éƒ¨ç½®ãçµ‚ã‚ã£ãŸã‹ã€ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ãŸå ´åˆã¯åœæ­¢
                if (placed >= maxBlocks || !game.gameActive || game.currentPlayer !== 2) {
                    return;
                }
                
                let chosenMove = null; // AIãŒé¸ã‚“ã æ‰‹
                
                // AIã®ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ç•°ãªã‚‹æˆ¦ç•¥ã‚’ä½¿ã†
                if (aiLevel === 1) {
                    // ãƒ¬ãƒ™ãƒ«1: å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ 
                    chosenMove = getRandomMove();
                } else if (aiLevel === 2) {
                    // ãƒ¬ãƒ™ãƒ«2: å‹ã¦ã‚‹æ‰‹ãŒã‚ã‚Œã°é¸ã¶ã€ãªã‘ã‚Œã°ãƒ©ãƒ³ãƒ€ãƒ 
                    chosenMove = findWinningMove(2) || getRandomMove();
                } else if (aiLevel === 3) {
                    // ãƒ¬ãƒ™ãƒ«3: æ”»æ’ƒã¨é˜²å¾¡ã‚’è€ƒãˆã‚‹
                    chosenMove = cpuPlayLevel3Move();
                } else if (aiLevel === 4) {
                    // ãƒ¬ãƒ™ãƒ«4: ã‚ˆã‚Šé«˜åº¦ãªæˆ¦ç•¥
                    chosenMove = cpuPlayLevel4Move();
                } else {
                    // ä¸æ˜ãªãƒ¬ãƒ™ãƒ«ã®å ´åˆã¯ãƒ©ãƒ³ãƒ€ãƒ 
                    chosenMove = getRandomMove();
                }
                
                // é¸ã‚“ã æ‰‹ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿å®Ÿè¡Œ
                if (chosenMove) {
                    placePiece(chosenMove[0], chosenMove[1]); // ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç½®ã
                    placed++; // ç½®ã„ãŸãƒ–ãƒ­ãƒƒã‚¯æ•°ã‚’å¢—ã‚„ã™
                    
                    // 0.5ç§’å¾Œã«æ¬¡ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç½®ãï¼ˆäººé–“ãŒè¦‹ã‚„ã™ãã™ã‚‹ãŸã‚ï¼‰
                    setTimeout(placeOneBlock, 500);
                } else {
                    // æœ‰åŠ¹ãªæ‰‹ãŒãªã„å ´åˆï¼ˆé€šå¸¸ã¯èµ·ã“ã‚‰ãªã„ï¼‰
                    console.warn("AIãŒæœ‰åŠ¹ãªæ‰‹ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸ");
                }
            }
            
            // ãƒ–ãƒ­ãƒƒã‚¯é…ç½®ã‚’é–‹å§‹
            placeOneBlock();
        }
        function getAllValidMoves() {
            const validMoves = [];
            for (let row = 0; row < GRID_HEIGHT; row++) {
                for (let col = 0; col < GRID_WIDTH; col++) {
                    if (game.grid[row][col] !== 0) continue;
                    const hasSupport = (row === GRID_HEIGHT - 1) || (game.grid[row + 1][col] !== 0);
                    const valid = (row !== GRID_HEIGHT - 1) || isValidGroundPlacement(col);
                    if (hasSupport && valid) {
                        validMoves.push([row, col]);
                    }
                }
            }
            return validMoves;
        }



        //CPUãƒ¬ãƒ™ãƒ«2
                function findWinningMove(player) {
            const directions = [
                [0, 1],  // æ¨ª
                [1, 0],  // ç¸¦
                [1, 1],  // æ–œã‚å³ä¸‹
                [1, -1]  // æ–œã‚å·¦ä¸‹
            ];
        
            for (let row = 0; row < GRID_HEIGHT; row++) {
                for (let col = 0; col < GRID_WIDTH; col++) {
                    if (game.grid[row][col] !== 0) continue;
        
                    const hasSupport = (row === GRID_HEIGHT - 1) || (game.grid[row + 1][col] !== 0);
                    const valid = (row !== GRID_HEIGHT - 1) || isValidGroundPlacement(col);
                    if (!hasSupport || !valid) continue;
        
                    // ä»®ã«ç½®ã„ã¦ã¿ã‚‹
                    game.grid[row][col] = player;
                    const win = checkWin(row, col);
                    game.grid[row][col] = 0; // å…ƒã«æˆ»ã™
        
                    if (win) return [row, col];
                }
            }
        
            return null;
        }
        
                function evaluateMove(grid, row, col, player) {
            let score = 0;
            const directions = [
                [0, 1],  [1, 0],  [1, 1],  [1, -1]
            ];
        
            for (let [dr, dc] of directions) {
                let count = 1;
        
                // æ­£æ–¹å‘
                for (let i = 1; i < 5; i++) {
                    const r = row + dr * i;
                    const c = col + dc * i;
                    if (grid[r] && grid[r][c] === player) count++;
                    else break;
                }
        
                // è² æ–¹å‘
                for (let i = 1; i < 5; i++) {
                    const r = row - dr * i;
                    const c = col - dc * i;
                    if (grid[r] && grid[r][c] === player) count++;
                    else break;
                }
        
                // å¾—ç‚¹åŠ ç®—ï¼ˆé€£ç¶šæ•°ã«å¿œã˜ã¦ï¼‰
                if (count >= 5) score += 10000;
                else score += count * count; // ä¾‹ï¼š3é€£=9ç‚¹
            }
        
            return score;
        }
        
              function cpuPlayLevel3Move() {
            // 1. ã¾ãšè‡ªåˆ†ï¼ˆAIï¼‰ãŒå‹ã¦ã‚‹æ‰‹ãŒã‚ã‚‹ã‹ç¢ºèª
            const winMove = findBestMoveForPlayer(2); // 2ã¯AIã®ç•ªå·
            if (winMove) return winMove;
            
            // 2. å‹ã¦ãªã„å ´åˆã€ç›¸æ‰‹ã®å‹åˆ©ã‚’é˜²ãæ‰‹ãŒã‚ã‚‹ã‹ç¢ºèª
            const blockMove = findBestMoveForPlayer(1); // 1ã¯äººé–“ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç•ªå·
            if (blockMove) return blockMove;
            
            // 3. ã©ã¡ã‚‰ã§ã‚‚ãªã„å ´åˆã¯ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶
            return getRandomMove();
        }
        
        // cpuPlayLevel4Moveé–¢æ•°ã‚‚åŒæ§˜ã«ä¿®æ­£
        function cpuPlayLevel4Move() {
            // ãƒ¬ãƒ™ãƒ«4ã§ã¯å°‘ã—è³¢ãã€è¤‡æ•°ã®æ‰‹ã‚’æ¯”è¼ƒã™ã‚‹
            const validMoves = getAllValidMoves();
            if (validMoves.length === 0) return null;
            
            let bestMove = null;
            let bestScore = -999999; // ã¨ã¦ã‚‚å°ã•ã„æ•°ã‹ã‚‰å§‹ã‚ã‚‹
            
            // å…¨ã¦ã®å¯èƒ½ãªæ‰‹ã‚’è©¦ã—ã¦ã€ä¸€ç•ªè‰¯ã„æ‰‹ã‚’é¸ã¶
            for (let i = 0; i < validMoves.length; i++) {
                const move = validMoves[i];
                const row = move[0];
                const col = move[1];
                
                // ã“ã®ä½ç½®ã«ç½®ã„ãŸæ™‚ã®ç‚¹æ•°ã‚’è¨ˆç®—
                game.grid[row][col] = 2; // ä»®ã«ç½®ã„ã¦ã¿ã‚‹
                let score = evaluateMove(game.grid, row, col, 2);
                game.grid[row][col] = 0; // å…ƒã«æˆ»ã™
                
                // ã‚ˆã‚Šé«˜ã„ç‚¹æ•°ãªã‚‰ã€ãã®æ‰‹ã‚’è¨˜éŒ²
                if (score > bestScore) {
                    bestScore = score;
                    bestMove = move;
                }
            }
            
            return bestMove;
        }
    ///LEVEL5
        function cpuPlayLevel5Move() {
            return cpuPlayLevel3Move(); // ã¨ã‚Šã‚ãˆãšåŒã˜ãƒ­ã‚¸ãƒƒã‚¯
        }




        // è½ä¸‹ä½ç½®è¨ˆç®—
        function calculateDrop(col) {
            for (var row = GRID_HEIGHT - 1; row >= 0; row--) {
                if (game.grid[row][col] === 0) {
                    return row;
                }
            }
            return -1; // åˆ—ãŒæº€æ¯
        }

        // åœ°é¢ãƒ¬ãƒ™ãƒ«ã®é…ç½®ãƒã‚§ãƒƒã‚¯
        function isValidGroundPlacementAt(row, col) {
            if (row !== GRID_HEIGHT - 1) return true; // åœ°é¢ä»¥å¤–ã¯OK
        
            // åœ°é¢ã®å ´åˆã€éš£æ¥ãƒ–ãƒ­ãƒƒã‚¯ãŒå¿…è¦
            var left = col - 1;
            var right = col + 1;
        
            if (left >= 0 && game.grid[row][left] !== 0) return true;
            if (right < GRID_WIDTH && game.grid[row][right] !== 0) return true;
        
            return false;
        }

        function isValidGroundPlacement(col) {
            const row = GRID_HEIGHT - 1;
            const left = col - 1;
            const right = col + 1;
            return (left >= 0 && game.grid[row][left] !== 0) || 
                   (right < GRID_WIDTH && game.grid[row][right] !== 0);
        }




        // å‹åˆ©ãƒã‚§ãƒƒã‚¯ï¼ˆæ”¹è‰¯ç‰ˆ - é€£ç¶šã™ã‚‹ã™ã¹ã¦ã®ã‚»ãƒ«ã‚’è¨˜éŒ²ï¼‰
        function checkWin(row, col) {
            var player = game.grid[row][col];
            var directions = [
                [0, 1],  // æ¨ª
                [1, 0],  // ç¸¦
                [1, 1],  // æ–œã‚å³ä¸‹
                [1, -1]  // æ–œã‚å·¦ä¸‹
            ];

            for (var d = 0; d < directions.length; d++) {
                var dr = directions[d][0];
                var dc = directions[d][1];
                var line = [[row, col]]; // ä¸­å¿ƒã‚»ãƒ«ã‹ã‚‰å§‹ã‚ã‚‹
                
                // å·¦å´ï¼ˆè² æ–¹å‘ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯
                for (var i = 1; i < WIN_COUNT; i++) {
                    var r = row - dr * i;
                    var c = col - dc * i;
                    if (r >= 0 && r < GRID_HEIGHT && c >= 0 && c < GRID_WIDTH && 
                        game.grid[r][c] === player) {
                        line.unshift([r, c]); // é…åˆ—ã®å‰ã«è¿½åŠ 
                    } else {
                        break;
                    }
                }
                
                // å³å´ï¼ˆæ­£æ–¹å‘ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯
                for (var i = 1; i < WIN_COUNT; i++) {
                    var r = row + dr * i;
                    var c = col + dc * i;
                    if (r >= 0 && r < GRID_HEIGHT && c >= 0 && c < GRID_WIDTH && 
                        game.grid[r][c] === player) {
                        line.push([r, c]); // é…åˆ—ã®å¾Œã«è¿½åŠ 
                    } else {
                        break;
                    }
                }
                
                if (line.length >= WIN_COUNT) {
                    game.winningCells = line;
                    return true;
                }
            }
            
            return false;
        }

        // å‹åˆ©ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ10ç§’å¾Œã«ç‚¹æ»…çµ‚äº†ã€ãã®å¾Œã‚²ãƒ¼ãƒ çµ‚äº†ï¼‰
        function showWinAnimation(callback) {
            updateDisplay(); // ç‚¹æ»…è¡¨ç¤ºã‚’åæ˜ 
            
            // 10ç§’å¾Œã«ç‚¹æ»…ã‚¯ãƒ©ã‚¹ã‚’è§£é™¤
            setTimeout(function() {
                var cells = document.querySelectorAll('.cell');
                for (var w = 0; w < game.winningCells.length; w++) {
                    var r = game.winningCells[w][0];
                    var c = game.winningCells[w][1];
                    var idx = r * GRID_WIDTH + c;
                     if (cells[idx]) {
            cells[idx].classList.remove('winning');
          }
        }

        // å‹åˆ©è¡¨ç¤ºã‚’å‡ºã—ã¦ã‚²ãƒ¼ãƒ çµ‚äº†
        endGame(game.currentPlayer);
        if (typeof callback === 'function') callback();
      }, 10000); // 10ç§’ï¼ˆ10000ãƒŸãƒªç§’ï¼‰
    }

    function endGame(winner) {
      game.gameActive = false;
      clearInterval(game.timer);
      resetFieldVisuals();

      var modal = document.getElementById('gameModal');
      var message = document.getElementById('modalMessage');
      var title = document.getElementById('modalTitle');
      var icon = document.getElementById('winnerIcon');

      if (winner === 1) {
        title.textContent = 'ğŸ‰ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®å‹åˆ©ï¼';
        icon.style.background = '#ef4444';
      } else if (winner === 2) {
        title.textContent = game.isAI ? 'ğŸ¤– AIã®å‹åˆ©ï¼' : 'ğŸ‰ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®å‹åˆ©ï¼';
        icon.style.background = '#3b82f6';
      } else {
        title.textContent = 'å¼•ãåˆ†ã‘';
        icon.style.background = '#ccc';
      }

      message.textContent = 'ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚å†æˆ¦ã—ã¾ã™ã‹ï¼Ÿ';
      modal.style.display = 'block';
    }

    function endGameNow() {
      endGame(0); // å¼•ãåˆ†ã‘ã¨ã—ã¦å‡¦ç†
      resetFieldVisuals();
    }

  </script>
</body>
</html>
